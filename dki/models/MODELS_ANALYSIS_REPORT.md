# DKI Models æ¨¡å—åˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**: 2026-02-13  
**åˆ†æèŒƒå›´**: `dki/models/` ç›®å½•å…¨éƒ¨æ–‡ä»¶ + `dki/adapters/config_driven_adapter.py`  
**åˆ†æç‰ˆæœ¬**: 1.0.0

---

## 1. ç›®å½•ç»“æ„ä¸èŒè´£

| æ–‡ä»¶ | èŒè´£ | ä»£ç è´¨é‡ |
|------|------|----------|
| `__init__.py` | ç»Ÿä¸€å¯¼å‡ºæ¥å£ | âœ… ä¼˜è‰¯ |
| `base.py` | åŸºç¡€æ¨¡å‹é€‚é…å™¨ + æ•°æ®ç»“æ„å®šä¹‰ | âš ï¸ å·²ä¿®æ­£ 1 å¤„é”™è¯¯ |
| `factory.py` | æ¨¡å‹å·¥å‚ (åˆ›å»º/ç®¡ç†é€‚é…å™¨) | âœ… ä¼˜è‰¯ |
| `deepseek_adapter.py` | DeepSeek æ¨¡å‹é€‚é…å™¨ | âš ï¸ å·²ä¿®æ­£ 1 å¤„é”™è¯¯ |
| `llama_adapter.py` | LLaMA æ¨¡å‹é€‚é…å™¨ | âš ï¸ å·²ä¿®æ­£ 1 å¤„é”™è¯¯ |
| `glm_adapter.py` | ChatGLM/GLM-4 æ¨¡å‹é€‚é…å™¨ | âš ï¸ å·²ä¿®æ­£ 1 å¤„é”™è¯¯ |
| `vllm_adapter.py` | vLLM é«˜æ€§èƒ½æ¨ç†é€‚é…å™¨ | âš ï¸ å·²ä¿®æ­£ 2 å¤„é”™è¯¯ |
| `config_driven_adapter.py` | é…ç½®é©±åŠ¨é€‚é…å™¨ | âœ… æœ‰è®¾è®¡å»ºè®® |

---

## 2. å„æ–‡ä»¶è¯¦ç»†åˆ†æ

### 2.1 `base.py` â€” åŸºç¡€æ¨¡å‹é€‚é…å™¨

**ä¿®æ­£ 1 å¤„é”™è¯¯:**

#### âŒ é”™è¯¯: `KVCacheEntry.from_bytes` ç¡¬ç¼–ç  `np.float16` å¯¼è‡´æ•°æ®æŸå

**ä¸¥é‡åº¦**: ğŸ”´ é«˜

**é—®é¢˜**: `from_bytes()` å§‹ç»ˆä½¿ç”¨ `np.frombuffer(key_bytes, dtype=np.float16)` è§£æå­—èŠ‚æµï¼Œè€Œä¸è€ƒè™‘å®é™… dtypeã€‚å¦‚æœæ¨¡å‹ä½¿ç”¨ `float32` (æ¯ä¸ªå…ƒç´  4 å­—èŠ‚)ï¼Œä½†æŒ‰ `float16` (æ¯ä¸ªå…ƒç´  2 å­—èŠ‚) è§£æï¼Œå…ƒç´ æ•°é‡ç¿»å€ï¼Œ`reshape(shape)` å°†å¤±è´¥ã€‚å³ä½¿ä¼ å…¥äº† `dtype` å‚æ•°ï¼Œå®ƒåªåœ¨ `.to(dtype)` è½¬æ¢æ—¶ä½¿ç”¨ï¼Œè€Œæ­¤æ—¶æ•°æ®å·²ç»è¢«é”™è¯¯è§£æã€‚

**ä¿®æ­£**: æ ¹æ® `dtype` å‚æ•°æ¨å¯¼å¯¹åº”çš„ `numpy dtype`ï¼Œç¡®ä¿å­—èŠ‚æµæŒ‰æ­£ç¡®çš„å…ƒç´ å¤§å°è§£æ:

```python
# ä¿®æ­£å: æ ¹æ® torch dtype ç¡®å®š numpy dtype
_torch_to_numpy = {
    torch.float16: np.float16,
    torch.float32: np.float32,
    torch.float64: np.float64,
    torch.bfloat16: np.float16,  # bfloat16 æ—  numpy å¯¹åº”, å­˜å‚¨ä¸º float16
}
np_dtype = _torch_to_numpy.get(dtype, np.float16)
```

**è®¾è®¡è¯„ä¼°**:
- `ModelOutput` æ•°æ®ç±»è®¾è®¡å®Œå–„ï¼ŒåŒ…å«æ–‡æœ¬ã€å¼ é‡ã€KVç¼“å­˜å’Œæ€§èƒ½æŒ‡æ ‡
- `BaseModelAdapter` æŠ½è±¡ç±»å®šä¹‰äº†æ¸…æ™°çš„æ¥å£ï¼š`load`, `generate`, `embed`, `compute_kv`, `forward_with_kv_injection`, `compute_prefill_entropy`
- FlashAttention æ”¯æŒä½œä¸ºå¯é€‰ç‰¹æ€§é›†æˆï¼Œè®¾è®¡åˆç†

---

### 2.2 `factory.py` â€” æ¨¡å‹å·¥å‚

**è¯„ä¼°**: âœ… æ— é”™è¯¯

**æ­£ç¡®æ€§åˆ†æ**:
- æ³¨å†Œè¡¨æ¨¡å¼ (`_adapters` dict) æ”¯æŒåŠ¨æ€æ³¨å†Œæ–°é€‚é…å™¨
- å•ä¾‹æ¨¡å¼ (`_instances` dict) é¿å…é‡å¤åŠ è½½ç›¸åŒæ¨¡å‹
- é…ç½®é©±åŠ¨: ä» `ConfigLoader` è¯»å–å¼•æ“é…ç½®
- `get_or_create` è‡ªåŠ¨åŠ è½½æ¨¡å‹ï¼Œå¯¹å¤–é€æ˜

**è®¾è®¡å»ºè®®**:
- `_instances` ä½œä¸ºç±»å˜é‡æ˜¯å…¨å±€å…±äº«çŠ¶æ€ï¼Œåœ¨æµ‹è¯•ä¸­å¯èƒ½éœ€è¦æ‰‹åŠ¨æ¸…ç†
- `unload(engine=None, model_name=None)` å½“åªä¼ ä¸€ä¸ªå‚æ•°æ—¶ï¼Œ`cache_key` ä¼šåŒ…å« `None`ï¼Œå¯èƒ½æ— æ³•åŒ¹é…å·²æœ‰å®ä¾‹

---

### 2.3 `deepseek_adapter.py` / `llama_adapter.py` / `glm_adapter.py` â€” HuggingFace é€‚é…å™¨

**ä¿®æ­£ 1 å¤„é”™è¯¯ (æ¯ä¸ªæ–‡ä»¶):**

#### âŒ é”™è¯¯: `compute_prefill_entropy` ç†µå€¼æœªå½’ä¸€åŒ–

**ä¸¥é‡åº¦**: ğŸŸ¡ ä¸­

**é—®é¢˜**: åŸå§‹å®ç° `entropy = -torch.sum(attn_weights * torch.log(attn_weights))` å¯¹æ³¨æ„åŠ›æƒé‡çš„æ‰€æœ‰ç»´åº¦ (batch, heads, seq_q, seq_k) æ±‚å’Œã€‚è¿™æ„å‘³ç€:
- ç†µå€¼éšè¾“å…¥åºåˆ—é•¿åº¦çº¿æ€§å¢é•¿
- ç†µå€¼éšæ³¨æ„åŠ›å¤´æ•°çº¿æ€§å¢é•¿
- ä¸åŒè¾“å…¥é•¿åº¦çš„ç†µå€¼ä¸å¯æ¯”è¾ƒ

è¿™å¯¼è‡´ `DualFactorGating` çš„é—¨æ§å†³ç­–åœ¨ä¸åŒè¾“å…¥é•¿åº¦ä¸‹ä¸ä¸€è‡´ã€‚

**ä¿®æ­£**: å¯¹æ¯è¡Œ (æ¯ä¸ªæ³¨æ„åŠ›åˆ†å¸ƒ) å•ç‹¬è®¡ç®—ç†µï¼Œç„¶åå–å¹³å‡:

```python
# ä¿®æ­£å: æ¯è¡Œç‹¬ç«‹è®¡ç®—ç†µï¼Œå†å¹³å‡
per_row_entropy = -torch.sum(attn_weights * torch.log(attn_weights), dim=-1)  # [batch, heads, seq_q]
entropy = per_row_entropy.mean()  # æ ‡é‡: å¹³å‡è¡Œç†µ
```

**å„é€‚é…å™¨ç‰¹ç‚¹**:
- **DeepSeek**: æ”¯æŒ `_format_prompt` èŠå¤©æ ¼å¼åŒ–
- **LLaMA**: æ”¯æŒ 8-bit é‡åŒ–åŠ è½½ (`load_in_8bit`)
- **GLM**: å…¼å®¹ GLM-4 çš„ `apply_chat_template` å’Œæ—§ç‰ˆ ChatGLM æ ¼å¼
- æ‰€æœ‰é€‚é…å™¨éƒ½å·²ä½¿ç”¨ `attn_implementation="eager"` (ä¹‹å‰çš„ä¿®æ­£)

---

### 2.4 `vllm_adapter.py` â€” vLLM é«˜æ€§èƒ½æ¨ç†é€‚é…å™¨

**ä¿®æ­£ 2 å¤„é”™è¯¯:**

#### âŒ é”™è¯¯ 1: `forward_with_kv_injection` æ ‡å‡†è·¯å¾„ç¼ºå¤± alpha ç¼©æ”¾

**ä¸¥é‡åº¦**: ğŸ”´ é«˜

**é—®é¢˜**: å…¶ä»–ä¸‰ä¸ªé€‚é…å™¨ (DeepSeek, LLaMA, GLM) éƒ½åœ¨ `forward_with_kv_injection` ä¸­åº”ç”¨äº† alpha ç¼©æ”¾:
```python
scaled_value = entry.value * alpha if alpha < 1.0 else entry.value
```
ä½† `VLLMAdapter` çš„æ ‡å‡†è·¯å¾„ç›´æ¥ä½¿ç”¨åŸå§‹ KV å€¼:
```python
past_kv = tuple((entry.key, entry.value) for entry in injected_kv)
```
FlashAttention è·¯å¾„åŒæ ·æœªåº”ç”¨ alphaã€‚è¿™å¯¼è‡´ DKI çš„æ ¸å¿ƒåŠŸèƒ½ MIS (Memory Influence Scaling) åœ¨ vLLM å¼•æ“ä¸‹å®Œå…¨å¤±æ•ˆã€‚

**ä¿®æ­£**: åœ¨æ ‡å‡†è·¯å¾„å’Œ FlashAttention è·¯å¾„éƒ½æ·»åŠ  alpha ç¼©æ”¾ã€‚

#### âŒ é”™è¯¯ 2: `compute_prefill_entropy` æœªå½’ä¸€åŒ–

(ä¸å…¶ä»–é€‚é…å™¨ç›¸åŒçš„ä¿®æ­£)

**è®¾è®¡è¯„ä¼°**:
- åŒæ¨¡å‹æ¶æ„ (vLLM ç”¨äºå¿«é€Ÿæ¨ç† + HF æ¨¡å‹ç”¨äº KV è®¡ç®—) æ˜¯åˆç†çš„æƒè¡¡
- `_forward_with_flash_attention` ç›®å‰æ˜¯ç®€åŒ–å®ç°ï¼ŒæœªçœŸæ­£è°ƒç”¨ `KVInjectionOptimizer`
- æ”¯æŒ `pad_token_id` å›é€€åˆ° `eos_token_id`ï¼Œå¥å£®æ€§æ›´å¥½

---

### 2.5 `config_driven_adapter.py` â€” é…ç½®é©±åŠ¨é€‚é…å™¨

**è¯„ä¼°**: âœ… æ— ä»£ç é”™è¯¯ (æœ‰è®¾è®¡å»ºè®®)

**æ­£ç¡®æ€§åˆ†æ**:
- `from_dict` æ”¯æŒä¸¤ç§é…ç½®æ ¼å¼ (ç®€åŒ–/å®Œæ•´)ï¼Œçµæ´»å®ç”¨
- `_reflect_tables` ä½¿ç”¨ SQLAlchemy åå°„ï¼Œè‡ªåŠ¨é€‚é…ä»»æ„è¡¨ç»“æ„
- JSON å†…å®¹è§£æ (`_extract_json_content`) æ”¯æŒåµŒå¥—è·¯å¾„ï¼Œå¤„ç†ä¸Šå±‚åº”ç”¨å­˜å‚¨ JSON æ ¼å¼å†…å®¹çš„åœºæ™¯
- ç¼“å­˜æœºåˆ¶ (`_get_cached`, `_set_cached`) æ”¯æŒ TTL è¿‡æœŸ

**è®¾è®¡å»ºè®®**:

1. **SQLite è¿æ¥æ± å‚æ•°**: `create_async_engine` å¯¹ SQLite ä¼ å…¥ `pool_size`, `max_overflow` ç­‰å‚æ•°å¯èƒ½äº§ç”Ÿè­¦å‘Šï¼Œå»ºè®® SQLite æ¨¡å¼ä½¿ç”¨ `NullPool`:
   ```python
   if self.adapter_config.database.type == DatabaseType.SQLITE:
       engine_kwargs['poolclass'] = NullPool
   ```

2. **pgvector SQL æ³¨å…¥é£é™©**: `_search_with_pgvector` ä½¿ç”¨ f-string æ‹¼æ¥ SQLï¼Œ`embedding_field`, `mapping.table`, `user_id_field` ç›´æ¥æ’å…¥æŸ¥è¯¢å­—ç¬¦ä¸²ã€‚è™½ç„¶è¿™äº›å€¼æ¥è‡ªé…ç½®è€Œéç”¨æˆ·è¾“å…¥ï¼Œä½†åœ¨å®‰å…¨æ•æ„Ÿç¯å¢ƒä¸‹å»ºè®®ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ã€‚

3. **ç¼“å­˜æ— å¤§å°é™åˆ¶**: `_cache` å­—å…¸æ²¡æœ‰æœ€å¤§å¤§å°é™åˆ¶ï¼Œé•¿æœŸè¿è¡Œå¯èƒ½å¯¼è‡´å†…å­˜å¢é•¿ã€‚å»ºè®®æ·»åŠ  LRU æ·˜æ±°ç­–ç•¥ã€‚

---

## 3. è·¨æ–‡ä»¶ä¸€è‡´æ€§åˆ†æ

| å¯¹æ¯”é¡¹ | DeepSeek | LLaMA | GLM | vLLM |
|--------|----------|-------|-----|------|
| Alpha ç¼©æ”¾ | âœ… | âœ… | âœ… | âœ… (å·²ä¿®æ­£) |
| Eager Attention | âœ… | âœ… | âœ… | âœ… (HF model) |
| ç†µå½’ä¸€åŒ– | âœ… (å·²ä¿®æ­£) | âœ… (å·²ä¿®æ­£) | âœ… (å·²ä¿®æ­£) | âœ… (å·²ä¿®æ­£) |
| Pad Token å¤„ç† | âœ… | âœ… | âœ… | âœ… (åŒå›é€€) |
| FlashAttention æ”¯æŒ | âŒ | âŒ | âŒ | âœ… (æ¡†æ¶) |
| Chat æ ¼å¼åŒ– | âœ… (ç®€åŒ–) | âŒ (ç›´æ¥ä¼ å…¥) | âœ… (apply_chat_template) | âŒ (vLLM å¤„ç†) |

---

## 4. ä¿®æ­£æ±‡æ€»

| # | æ–‡ä»¶ | é—®é¢˜ | ä¸¥é‡åº¦ | çŠ¶æ€ |
|---|------|------|--------|------|
| 1 | `base.py` | `from_bytes` ç¡¬ç¼–ç  `np.float16` | ğŸ”´ é«˜ | âœ… å·²ä¿®æ­£ |
| 2 | `vllm_adapter.py` | ç¼ºå¤± alpha ç¼©æ”¾ | ğŸ”´ é«˜ | âœ… å·²ä¿®æ­£ |
| 3 | `deepseek_adapter.py` | ç†µæœªå½’ä¸€åŒ– | ğŸŸ¡ ä¸­ | âœ… å·²ä¿®æ­£ |
| 4 | `llama_adapter.py` | ç†µæœªå½’ä¸€åŒ– | ğŸŸ¡ ä¸­ | âœ… å·²ä¿®æ­£ |
| 5 | `glm_adapter.py` | ç†µæœªå½’ä¸€åŒ– | ğŸŸ¡ ä¸­ | âœ… å·²ä¿®æ­£ |
| 6 | `vllm_adapter.py` | ç†µæœªå½’ä¸€åŒ– | ğŸŸ¡ ä¸­ | âœ… å·²ä¿®æ­£ |

---

## 5. æ•´ä½“æ¶æ„è¯„ä¼°

### ä¼˜ç‚¹
1. **ç»Ÿä¸€æ¥å£**: `BaseModelAdapter` æä¾›ä¸€è‡´çš„æŠ½è±¡ï¼Œæ–°æ¨¡å‹å¼•æ“å¯ä»¥è½»æ¾é›†æˆ
2. **å·¥å‚æ¨¡å¼**: `ModelFactory` ç®€åŒ–æ¨¡å‹åˆ›å»ºï¼Œæ”¯æŒé…ç½®é©±åŠ¨å’Œå•ä¾‹ç®¡ç†
3. **FlashAttention å¯é€‰**: ä½œä¸ºå¢å¼ºç‰¹æ€§ï¼Œä¸å½±å“åŸºç¡€åŠŸèƒ½
4. **ConfigDrivenAdapter**: é›¶ä»£ç é›†æˆä¸Šå±‚åº”ç”¨æ•°æ®åº“ï¼Œå¤§å¹…é™ä½é›†æˆæˆæœ¬

### å¾…æ”¹è¿›
1. vLLM çš„ FlashAttention è·¯å¾„å½“å‰æ˜¯å ä½å®ç°ï¼ŒæœªçœŸæ­£åˆ©ç”¨ `KVInjectionOptimizer`
2. DeepSeek çš„èŠå¤©æ¨¡æ¿è¾ƒç®€åŒ–ï¼Œå¯è€ƒè™‘ä½¿ç”¨ `apply_chat_template`
3. `KVCacheEntry.to_bytes()` ä¸ä¿å­˜ dtype ä¿¡æ¯ï¼Œéœ€è¦è°ƒç”¨æ–¹è‡ªè¡Œç»´æŠ¤
