# DKI - Dynamic KV Injection åŠ¨æ€é”®å€¼æ³¨å…¥--å¤§è¯­è¨€æ¨¡å‹ç”¨æˆ·çº§è®°å¿†ç³»ç»Ÿ

> å¤§å‹è¯­è¨€æ¨¡å‹çš„æ³¨æ„åŠ›å±‚çº§ç”¨æˆ·è®°å¿†æ’ä»¶

[![Python 3.10+](https://img.shields.io/badge/python-3.10+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

[English](README.md) | ç®€ä½“ä¸­æ–‡

## ğŸ“– æ¦‚è¿°

DKI (Dynamic KV Injectionï¼ŒåŠ¨æ€é”®å€¼æ³¨å…¥) æ˜¯ä¸€ä¸ª**LLM æ³¨æ„åŠ›å±‚çº§æ’ä»¶**ï¼Œé€šè¿‡ Attention Hook åœ¨æ¨ç†æ—¶åŠ¨æ€æ³¨å…¥ç”¨æˆ·åå¥½å’Œä¼šè¯å†å²ï¼Œå®ç°è·¨ä¼šè¯çš„ä¸ªæ€§åŒ–è®°å¿†ã€‚

### DKI æ˜¯ä»€ä¹ˆ

DKI æ˜¯ä¸€ä¸ª **LLM æ’ä»¶**ï¼Œä¸“ä¸º**ç”¨æˆ·çº§è®°å¿†**è®¾è®¡ï¼š

-   **æ³¨æ„åŠ› Hook æœºåˆ¶**ï¼šé€šè¿‡ PyTorch Hook åœ¨æ³¨æ„åŠ›å±‚çº§æ³¨å…¥ K/Vï¼Œè€Œé prompt æ‹¼æ¥
-   **é…ç½®é©±åŠ¨é€‚é…å™¨**ï¼šè‡ªåŠ¨è¯»å–ä¸Šå±‚åº”ç”¨çš„æ•°æ®åº“ï¼Œæ— éœ€ä¿®æ”¹ä¸Šå±‚åº”ç”¨ä»£ç 
-   **æ··åˆæ³¨å…¥ç­–ç•¥**ï¼šåå¥½ K/V æ³¨å…¥ï¼ˆè´Ÿä½ç½®ï¼‰+ å†å²åç¼€æç¤ºè¯ï¼ˆæ­£ä½ç½®ï¼‰

**æ ¸å¿ƒå·¥ä½œæµ**ï¼š

```
ä¸Šå±‚åº”ç”¨ â†’ ä¼ é€’ user_id + åŸå§‹è¾“å…¥ â†’ DKI æ’ä»¶
    â†“
DKI é€šè¿‡é…ç½®é©±åŠ¨é€‚é…å™¨è¯»å–ä¸Šå±‚åº”ç”¨æ•°æ®åº“
    â†“
åå¥½ â†’ K/V æ³¨å…¥ (è´Ÿä½ç½®) | å†å² â†’ åç¼€æç¤ºè¯ (æ­£ä½ç½®)
    â†“
è°ƒç”¨ LLM æ¨ç† â†’ è¿”å›å“åº”
```

### DKI ä¸æ˜¯ä»€ä¹ˆ

-   **ä¸æ˜¯ RAG**ï¼šDKI ä½¿ç”¨ K/V æ³¨å…¥è€Œé prompt æ‹¼æ¥ï¼Œä¸æ¶ˆè€— token é¢„ç®—
-   **ä¸æ˜¯çŸ¥è¯†åº“æ£€ç´¢**ï¼šDKI ä¸“æ³¨äºç”¨æˆ·çº§è®°å¿†ï¼Œå¤–éƒ¨çŸ¥è¯†è¯·ä½¿ç”¨ RAG
-   **ä¸éœ€è¦ä¸Šå±‚åº”ç”¨å®ç°æ¥å£**ï¼šé…ç½®é©±åŠ¨ï¼Œä¸Šå±‚åº”ç”¨åªéœ€ä¼ é€’ user_id å’ŒåŸå§‹è¾“å…¥

### ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªå®šä½

è¿™ç§èšç„¦çš„èŒƒå›´å¸¦æ¥ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **çŸ­åå¥½**ï¼ˆ50-200 tokensï¼‰â†’ é™ä½ä½ç½®ç¼–ç é£é™©ï¼Œå¯ç¼“å­˜
2. **ç”¨æˆ·è‡ªæœ‰æ•°æ®** â†’ ç®€åŒ–éšç§è€ƒé‡
3. **ä¼šè¯è¿è´¯** â†’ æœ‰æ•ˆçš„ K/V ç¼“å­˜
4. **ç¨³å®šåå¥½** â†’ é«˜ç¼“å­˜å¤ç”¨ç‡

### æ ¸å¿ƒç‰¹æ€§

-   **ğŸ§  æ³¨æ„åŠ› Hook æ³¨å…¥**ï¼šé€šè¿‡ PyTorch Hook åœ¨æ³¨æ„åŠ›å±‚çº§æ³¨å…¥ K/Vï¼Œè€Œé prompt token
-   **ğŸ”€ æ··åˆæ³¨å…¥ç­–ç•¥**ï¼šåå¥½ï¼ˆK/V è´Ÿä½ç½®ï¼‰+ å†å²ï¼ˆåç¼€æç¤ºè¯æ­£ä½ç½®ï¼‰
-   **ğŸ”§ é…ç½®é©±åŠ¨é€‚é…å™¨**ï¼šSQLAlchemy åŠ¨æ€è¡¨æ˜ å°„ï¼Œæ— éœ€ä¸Šå±‚åº”ç”¨å®ç°æ¥å£
-   **ğŸšï¸ è®°å¿†å½±å“ç¼©æ”¾ï¼ˆMISï¼‰**ï¼šè¿ç»­çš„ Î± âˆˆ [0, 1] å¼ºåº¦æ§åˆ¶
-   **ğŸ”„ æŸ¥è¯¢æ¡ä»¶æŠ•å½±**ï¼šFiLM é£æ ¼çš„è®°å¿†ä¸­å¿ƒå˜æ¢
-   **ğŸš¦ åŒå› å­é—¨æ§**ï¼šç›¸å…³æ€§é©±åŠ¨å†³ç­–ï¼Œç†µè°ƒåˆ¶å¼ºåº¦
-   **ğŸ’¾ åˆ†å±‚ KV ç¼“å­˜**ï¼šL1(GPU) â†’ L2(CPU) â†’ L3(SSD) â†’ L4(é‡è®¡ç®—)
-   **ğŸ“Š ç›‘æ§ API**ï¼šç»Ÿè®¡æ•°æ®ã€æ³¨å…¥æ—¥å¿—ã€å¥åº·æ£€æŸ¥
-   **ğŸ”Œ å¤šå¼•æ“æ”¯æŒ**ï¼švLLMã€LLaMAã€DeepSeekã€GLM
-   **âœ… ä¼˜é›…é™çº§**ï¼šÎ± â†’ 0 å¹³æ»‘å›é€€åˆ°æ™®é€š LLM è¡Œä¸º

## ğŸ—ï¸ æ¶æ„

### æ ¸å¿ƒæ¶æ„ï¼šLLM æ’ä»¶æ¨¡å¼

DKI ä½œä¸º LLM çš„**æ³¨æ„åŠ›å±‚çº§æ’ä»¶**ï¼Œé€šè¿‡ PyTorch Hook æœºåˆ¶å®ç° K/V æ³¨å…¥ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DKI æ’ä»¶æ¶æ„                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ä¸Šå±‚åº”ç”¨ (Chat UI / å®¢æœç³»ç»Ÿ / å…¶ä»–åº”ç”¨)                         â”‚    â”‚
â”‚  â”‚  â””â”€â”€ åªéœ€ä¼ é€’: user_id + åŸå§‹ç”¨æˆ·è¾“å…¥                             â”‚    â”‚
â”‚  â”‚      (æ— éœ€ RAG, æ— éœ€ Prompt å·¥ç¨‹, æ— éœ€å®ç°æ¥å£)                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  DKI æ’ä»¶                                                       â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ é…ç½®é©±åŠ¨é€‚é…å™¨ (SQLAlchemy åŠ¨æ€è¡¨æ˜ å°„)                       â”‚    â”‚
â”‚  â”‚  â”‚   â””â”€â”€ è¯»å–ä¸Šå±‚åº”ç”¨æ•°æ®åº“ (ç”¨æˆ·åå¥½ + å†å²æ¶ˆæ¯)                  â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ åå¥½å¤„ç† â†’ K/V æ³¨å…¥ (è´Ÿä½ç½®, Attention Hook)                 â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ å†å²å¤„ç† â†’ åç¼€æç¤ºè¯ (æ­£ä½ç½®)                               â”‚    â”‚
â”‚  â”‚  â””â”€â”€ ç›‘æ§ API (ç»Ÿè®¡/æ—¥å¿—/å¥åº·æ£€æŸ¥)                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  LLM å¼•æ“ (vLLM / LLaMA / DeepSeek / GLM)                       â”‚    â”‚
â”‚  â”‚  â””â”€â”€ å¸¦ K/V æ³¨å…¥çš„æ¨ç†                                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ³¨å…¥ç­–ç•¥é€‰æ‹©

DKI æä¾›ä¸¤ç§æ³¨å…¥ç­–ç•¥ï¼Œå¯é€šè¿‡é…ç½®åˆ‡æ¢ï¼š

| ç­–ç•¥               | é€‚ç”¨åœºæ™¯ | Context å ç”¨ | ç¨³å®šæ€§     | ç ”ç©¶ä»·å€¼   |
| ------------------ | -------- | ------------ | ---------- | ---------- |
| **stable** (é»˜è®¤)  | ç”Ÿäº§ç¯å¢ƒ | ä¸­ç­‰         | â­â­â­â­â­ | â­â­       |
| **full_attention** | ç ”ç©¶å®éªŒ | æå°         | â­â­â­     | â­â­â­â­â­ |

```yaml
# config.yaml
dki:
    injection_strategy: "stable" # stable | full_attention
```

### æ··åˆæ³¨å…¥ç­–ç•¥ (Stable)

**é»˜è®¤ç­–ç•¥**ï¼Œä½¿ç”¨**åˆ†å±‚æ³¨å…¥æ–¹æ³•**ï¼Œæ¨¡æ‹Ÿäººç±»è®¤çŸ¥ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DKI æ··åˆæ³¨å…¥æ¶æ„ (Stable)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç¬¬1å±‚ï¼šç”¨æˆ·åå¥½ï¼ˆK/V æ³¨å…¥ - Attention Hookï¼‰                     â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ å†…å®¹ï¼šé¥®é£Ÿã€é£æ ¼ã€å…´è¶£                                       â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ ä½ç½®ï¼šè´Ÿä½ç½®ï¼ˆæ¦‚å¿µä¸Šåœ¨ç”¨æˆ·è¾“å…¥"ä¹‹å‰"ï¼‰                        â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ æœºåˆ¶ï¼šPyTorch Hook ä¿®æ”¹ Attention çš„ K/V                    â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ å½±å“ï¼šéšå¼ã€èƒŒæ™¯ï¼ˆå¦‚åŒäººæ ¼ï¼‰                                 â”‚    â”‚
â”‚  â”‚  â””â”€â”€ Î±ï¼š0.3-0.5ï¼ˆè¾ƒä½ï¼Œç”¨äºå¾®å¦™å½±å“ï¼‰                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç¬¬2å±‚ï¼šä¼šè¯å†å²ï¼ˆåç¼€æç¤ºè¯ï¼‰                                     â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ å†…å®¹ï¼šè¿‘æœŸå¯¹è¯è½®æ¬¡                                           â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ ä½ç½®ï¼šç”¨æˆ·æŸ¥è¯¢ä¹‹åï¼ˆæ­£ä½ç½®ï¼‰                                  â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ æœºåˆ¶ï¼šæ ‡å‡† token æ‹¼æ¥                                        â”‚    â”‚
â”‚  â”‚  â”œâ”€â”€ å½±å“ï¼šæ˜¾å¼ã€å¯å¼•ç”¨ï¼ˆå¦‚åŒè®°å¿†ï¼‰                                â”‚    â”‚
â”‚  â”‚  â””â”€â”€ æç¤ºè¯ï¼šå»ºç«‹ä¿¡ä»»çš„å¼•å¯¼                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç¬¬3å±‚ï¼šå½“å‰æŸ¥è¯¢ï¼ˆæ ‡å‡†è¾“å…¥ï¼‰                                      â”‚    â”‚
â”‚  â”‚  â””â”€â”€ æ³¨æ„åŠ›çš„ä¸»è¦ç„¦ç‚¹                                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Full Attention / Engram-Inspired ç­–ç•¥ (âš ï¸ å·²å¼ƒç”¨)

> **å¼ƒç”¨è¯´æ˜**: Full Attention ç­–ç•¥å’Œ Engram-Inspired Injection ç­–ç•¥å·²å¼ƒç”¨ã€‚è¿™ä¸¤ç§ç­–ç•¥å°†åå¥½å’Œå†å²å‡é€šè¿‡ K/V æ³¨å…¥å®ç°æ¥è¿‘é›¶çš„ Context å ç”¨ï¼Œä½†åœ¨**é•¿å†å²ä¿¡æ¯**åœºæ™¯ä¸‹å­˜åœ¨æ ¹æœ¬æ€§å±€é™ï¼š
>
> 1. **K/V æ³¨å…¥å®¹é‡æœ‰é™**: å½“å†å²æ¶ˆæ¯é‡è¾ƒå¤§æ—¶ï¼ŒK/V æ³¨å…¥çš„ token æ•°é‡æ€¥å‰§å¢é•¿ï¼Œè¶…å‡ºæ³¨æ„åŠ›æœºåˆ¶çš„æœ‰æ•ˆå¤„ç†èŒƒå›´
> 2. **å†å²æ— æ³•è¢«æ˜¾å¼å¼•ç”¨**: é€šè¿‡ K/V æ³¨å…¥çš„å†å²æ¶ˆæ¯æ— æ³•è¢«æ¨¡å‹æ˜¾å¼å¼•ç”¨æˆ–æ¨ç†ï¼Œä»…èƒ½äº§ç”Ÿéšå¼å½±å“
> 3. **OOD é£é™©**: å¤§é‡å†å² K/V æ³¨å…¥åœ¨è´Ÿä½ç½®å¯èƒ½å¯¼è‡´æ³¨æ„åŠ›åˆ†å¸ƒä¸¥é‡åç¦»è®­ç»ƒåˆ†å¸ƒ
> 4. **äº‹å®å‡†ç¡®æ€§ä¸è¶³**: æ¨¡å‹æ— æ³•ä» K/V æ³¨å…¥ä¸­å‡†ç¡®æå–å…·ä½“äº‹å®ï¼ˆå¦‚æ—¥æœŸã€ä»·æ ¼ç­‰ï¼‰
>
> **æ›¿ä»£æ–¹æ¡ˆ**: è¯·ä½¿ç”¨ **Recall v4 è®°å¿†å¬å›ç­–ç•¥**ï¼ˆè§ä¸‹æ–‡ï¼‰ï¼Œè¯¥ç­–ç•¥é€šè¿‡å¤šä¿¡å·æ£€ç´¢ + åŠ¨æ€æ‘˜è¦ + åº”ç”¨å±‚äº‹å®è¡¥å……ï¼Œåœ¨é•¿å†å²åœºæ™¯ä¸‹æä¾›ç¨³å®šå¯é çš„è®°å¿†å¬å›èƒ½åŠ›ã€‚

<details>
<summary>Full Attention ç­–ç•¥åŸå§‹è¯´æ˜ï¼ˆå·²å¼ƒç”¨ï¼Œç‚¹å‡»å±•å¼€ï¼‰</summary>

æ ¸å¿ƒå®ç°ä½äº `dki/core/injection/full_attention_injector.py`ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DKI Full Attention æ¶æ„ (Research)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ä½ç½®å¸ƒå±€:                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  [History KV]     â”‚  [Preference KV]   â”‚  [Query + Indication]  â”‚    â”‚
â”‚  â”‚  pos: -500~-101   â”‚  pos: -100~-1      â”‚  pos: 0~L              â”‚    â”‚
â”‚  â”‚  Î±: 0.3           â”‚  Î±: 0.4            â”‚  Î±: 1.0                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚  ç‰¹ç‚¹:                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  âœ… Context å ç”¨æå° (ä»… 3-5 tokens å…¨å±€æŒ‡ç¤º)                    â”‚    â”‚
â”‚  â”‚  âœ… å†å²ä¹Ÿé€šè¿‡ K/V æ³¨å…¥ï¼Œä¸æ¶ˆè€— token é¢„ç®—                        â”‚    â”‚
â”‚  â”‚  âš ï¸ å¯èƒ½å­˜åœ¨ OOD é£é™© (éœ€è¦å®éªŒéªŒè¯)                              â”‚    â”‚
â”‚  â”‚  âš ï¸ å†å²æ— æ³•è¢«æ˜¾å¼å¼•ç”¨ (éšå¼å½±å“)                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚  ç ”ç©¶ç›®çš„:                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  1. éªŒè¯å†å²æ¶ˆæ¯ K/V æ³¨å…¥çš„å¯è¡Œæ€§                                 â”‚    â”‚
â”‚  â”‚  2. å¯¹æ¯” Stable ç­–ç•¥çš„è¾“å‡ºè´¨é‡                                    â”‚    â”‚
â”‚  â”‚  3. æ”¶é›† attention pattern æ•°æ®                                  â”‚    â”‚
â”‚  â”‚  4. æ¢ç´¢ 0% Context å ç”¨çš„æé™                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Full Attention æ³¨å…¥å™¨å®ç°

`FullAttentionInjector` ç±»ï¼ˆ`dki/core/injection/full_attention_injector.py`ï¼‰æ˜¯ Full Attention ç­–ç•¥çš„æ ¸å¿ƒå®ç°ï¼Œä¸»è¦è®¾è®¡ç»†èŠ‚å¦‚ä¸‹ï¼š

**ä½ç½®ç¼–ç æ¨¡å¼**ï¼šæ”¯æŒä¸‰ç§æ¨¡å¼ï¼Œé€šè¿‡ `position_mode` é…ç½®åˆ‡æ¢ï¼š

| æ¨¡å¼             | è¯´æ˜                           | é€‚ç”¨åœºæ™¯           |
| ---------------- | ------------------------------ | ------------------ |
| `fixed_negative` | è®°å¿† token æ˜ å°„åˆ°è´Ÿä½ç½® (RoPE) | é»˜è®¤æ¨¡å¼ï¼Œæ¸…æ™°åˆ†ç¦» |
| `constant`       | æ‰€æœ‰è®°å¿† token å…±äº«ç›¸åŒä½ç½®    | æµ‹è¯•ä½ç½®æ— å…³æ€§     |
| `nope`           | ä¸å¯¹è®°å¿† K/V åº”ç”¨ä½ç½®ç¼–ç       | æµ‹è¯• NoPE å‡è®¾     |

**ä»…å€¼ç¼©æ”¾ï¼ˆEngram å¯å‘ï¼‰**ï¼šæ³¨å…¥å™¨ä»…å¯¹ Value å¼ é‡åº”ç”¨ Î± ç¼©æ”¾ï¼ŒKey ä¿æŒä¸å˜ã€‚è¿™ä¿ç•™äº†æ³¨æ„åŠ›å¯»å€ç²¾åº¦ï¼ŒåŒæ—¶è°ƒåˆ¶è®°å¿†å½±å“å¼ºåº¦â€”â€”è¯¥åŸåˆ™å€Ÿé‰´è‡ª Engram [arXiv:2601.07372]ï¼š

```python
# Keyï¼ˆåœ°å€ï¼‰ä¸ç¼©æ”¾ â€” ä¿æŒåŒ¹é…ç²¾åº¦
# Valueï¼ˆè¾“å‡ºè´¡çŒ®ï¼‰ç¼©æ”¾ â€” è°ƒåˆ¶å½±å“å¼ºåº¦
h_v = h_v * history_alpha     # ä¾‹å¦‚ 0.3
p_v = p_v * preference_alpha  # ä¾‹å¦‚ 0.4
```

**K/V åˆå¹¶ç­–ç•¥**ï¼šå†å²å’Œåå¥½çš„ K/V å¯¹æŒ‰å±‚åˆå¹¶ï¼Œå†å²ä½äºæ›´è¿œçš„è´Ÿä½ç½®ï¼ˆè¿œç¦»æŸ¥è¯¢ï¼‰ï¼Œåå¥½ä½äºæ›´è¿‘çš„è´Ÿä½ç½®ï¼š

```
æ¯å±‚åˆå¹¶å¸ƒå±€: [å†å² K/V (è¿œè´Ÿä½ç½®)] [åå¥½ K/V (è¿‘è´Ÿä½ç½®)] [ç”¨æˆ· K/V (æ­£ä½ç½®)]
```

**å®‰å…¨æœºåˆ¶**ï¼š

-   **Token é™åˆ¶**ï¼šå¦‚æœæ€» K/V token æ•°è¶…è¿‡ `max_total_kv_tokens`ï¼ˆé»˜è®¤ï¼š600ï¼‰ï¼Œæ³¨å…¥å™¨ä¼šå›é€€åˆ° Stable ç­–ç•¥æˆ–æˆªæ–­å†å²ï¼ˆä¿ç•™æœ€è¿‘çš„æ¶ˆæ¯ï¼‰
-   **Attention æ¨¡å¼æ—¥å¿—**ï¼šå¯ç”¨æ—¶ï¼Œè®°å½•ä½ç½®åˆ†å¸ƒã€token ç»Ÿè®¡å’Œè®¡ç®—æ—¶é—´ï¼Œç”¨äºç ”ç©¶åˆ†æ
-   **ä¼˜é›…å›é€€**ï¼šä»»ä½•é”™è¯¯æƒ…å†µä¸‹è¿”å›æœªæ³¨å…¥ç»“æœï¼Œç¡®ä¿æ™®é€š LLM æ­£å¸¸è¿è¡Œ

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
dki:
    injection_strategy: "full_attention"

    full_attention:
        enabled: true
        position_mode: "fixed_negative" # fixed_negative | constant | nope

        preference:
            position_start: -100
            alpha: 0.4

        history:
            position_start: -500
            alpha: 0.3
            max_tokens: 400

        global_indication:
            enabled: true
            text_en: "[Memory Context Available]"
            text_cn: "[è®°å¿†ä¸Šä¸‹æ–‡å¯ç”¨]"
```

**è¿è¡Œæ—¶åˆ‡æ¢ç­–ç•¥**ï¼š

```python
# åˆ‡æ¢åˆ° full_attention ç­–ç•¥
dki.switch_injection_strategy("full_attention")

# åˆ‡æ¢å› stable ç­–ç•¥
dki.switch_injection_strategy("stable")

# è·å– full_attention ç»Ÿè®¡
stats = dki.get_full_attention_stats()

# è·å– attention pattern æ—¥å¿— (ç”¨äºç ”ç©¶åˆ†æ)
logs = dki.get_full_attention_logs(limit=50)
```

</details>

### Recall v4 è®°å¿†å¬å›ç­–ç•¥ (æ¨è)

**ç”Ÿäº§æ¨èç­–ç•¥**ã€‚æ¨¡æ‹Ÿäººç±»è®°å¿†å¬å›è¿‡ç¨‹ï¼Œé€šè¿‡å¤šä¿¡å·æ£€ç´¢ã€åŠ¨æ€å†å²æ„é€ å’Œåº”ç”¨å±‚äº‹å®è¡¥å……ï¼Œåœ¨é•¿å†å²åœºæ™¯ä¸‹æä¾›ç¨³å®šå¯é çš„è®°å¿†èƒ½åŠ›ã€‚æ ¸å¿ƒå®ç°ä½äº `dki/core/recall/`ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DKI Recall v4 è®°å¿†å¬å›æ¶æ„                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Phase 1: å¤šä¿¡å·å¬å›                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç”¨æˆ·è¾“å…¥ â†’ [å…³é”®è¯+æƒé‡] + [æŒ‡ä»£è§£æ] + [å‘é‡ç›¸ä¼¼åº¦]            â”‚    â”‚
â”‚  â”‚           â†’  åŠ æƒåˆå¹¶ + å½’ä¸€åŒ–  â†’  å…³è”æ¶ˆæ¯åˆ—è¡¨                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†“                                              â”‚
â”‚  Phase 2: åŠ¨æ€ History æ„é€                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  éå†æ¶ˆæ¯åˆ—è¡¨:                                                   â”‚    â”‚
â”‚  â”‚    è¶…é˜ˆå€¼ â†’ [SUMMARY] + trace_id (å¯è¿½æº¯)                       â”‚    â”‚
â”‚  â”‚    é˜ˆå€¼å†… â†’ åŸå§‹æ¶ˆæ¯                                             â”‚    â”‚
â”‚  â”‚  + æœ€è¿‘ N è½®å®Œæ•´å¯¹è¯                                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                          â†“                                              â”‚
â”‚  Phase 3: æ¨¡å‹é€‚é… + æ¨ç†                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  [History åç¼€] + [å¯ä¿¡+æ¨ç†é™å®šæç¤º] + [åå¥½ K/V æ³¨å…¥] + [Query]â”‚    â”‚
â”‚  â”‚  â†’ LLM æ¨ç† â†’ æ£€æµ‹ retrieve_fact è°ƒç”¨                           â”‚    â”‚
â”‚  â”‚  â†’ äº‹å®è¡¥å…… (æ”¯æŒåˆ†å— offset+limit) â†’ ç»§ç»­æ¨ç†                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚  ä¼˜åŠ¿:                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  âœ… é•¿å†å²åœºæ™¯ç¨³å®šå¯é                                            â”‚    â”‚
â”‚  â”‚  âœ… äº‹å®å¯è¿½æº¯ (trace_id â†’ åŸå§‹æ¶ˆæ¯)                             â”‚    â”‚
â”‚  â”‚  âœ… åŠ¨æ€ Context é¢„ç®—ç®¡ç†                                        â”‚    â”‚
â”‚  â”‚  âœ… å¤šæ¨¡å‹é€‚é… (DeepSeek, GLM, é€šç”¨)                             â”‚    â”‚
â”‚  â”‚  âœ… åå¥½ä»é€šè¿‡ K/V æ³¨å…¥ (å¤ç”¨å·²æœ‰æœºåˆ¶)                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
dki:
    injection_strategy: "recall_v4"

    recall:
        enabled: true
        strategy: "summary_with_fact_call"

        signals:
            keyword_enabled: true
            keyword_topk: 5
            keyword_method: "tfidf"
            vector_enabled: true
            vector_top_k: 10

        budget:
            generation_reserve: 512
            min_recent_turns: 2
            max_recent_turns: 5

        summary:
            per_message_threshold: 200
            strategy: "extractive" # extractive (jieba TextRank) | llm

        fact_call:
            enabled: true
            max_rounds: 3
            max_fact_tokens: 800
```

**è¿è¡Œæ—¶åˆ‡æ¢ç­–ç•¥**ï¼š

```python
# åˆ‡æ¢åˆ° recall_v4 ç­–ç•¥
dki.switch_injection_strategy("recall_v4")

# åˆ‡æ¢å› stable ç­–ç•¥
dki.switch_injection_strategy("stable")
```

### æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DKI æ•°æ®æµ                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·æŸ¥è¯¢ + user_id + session_id                                         â”‚
â”‚       â”‚                                                                 â”‚
â”‚       â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  1. é…ç½®é©±åŠ¨é€‚é…å™¨è¯»å–ä¸Šå±‚åº”ç”¨æ•°æ®åº“                               â”‚    â”‚
â”‚  â”‚     â”œâ”€â”€ ç”¨æˆ·åå¥½è¡¨ â†’ åå¥½åˆ—è¡¨                                     â”‚    â”‚
â”‚  â”‚     â””â”€â”€ æ¶ˆæ¯è¡¨ â†’ ç›¸å…³å†å² (å‘é‡æ£€ç´¢/BM25/å…³é”®è¯)                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  2. åå¥½å¤„ç†                                                     â”‚    â”‚
â”‚  â”‚     â”œâ”€â”€ æ ¼å¼åŒ–åå¥½æ–‡æœ¬                                            â”‚    â”‚
â”‚  â”‚     â”œâ”€â”€ è®¡ç®—/ç¼“å­˜ K/V è¡¨ç¤º                                        â”‚    â”‚
â”‚  â”‚     â””â”€â”€ å‡†å¤‡ Attention Hook                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  3. å†å²å¤„ç†                                                     â”‚    â”‚
â”‚  â”‚     â””â”€â”€ æ ¼å¼åŒ–ä¸ºåç¼€æç¤ºè¯ (å¸¦ä¿¡ä»»å¼•å¯¼)                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  4. LLM æ¨ç† (å¸¦ K/V æ³¨å…¥)                                       â”‚    â”‚
â”‚  â”‚     â”œâ”€â”€ Attention Hook æ³¨å…¥åå¥½ K/V (è´Ÿä½ç½®)                     â”‚    â”‚
â”‚  â”‚     â””â”€â”€ è¾“å…¥ = æŸ¥è¯¢ + å†å²åç¼€ (æ­£ä½ç½®)                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  5. è¿”å›å“åº” + è®°å½•ç›‘æ§æ•°æ®                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

> ğŸ“– **å®Œæ•´éƒ¨ç½²æŒ‡å—**ï¼šå¦‚æœæ‚¨éœ€è¦ä»é›¶å¼€å§‹åœ¨ Ubuntu Server ä¸Šéƒ¨ç½² DKI + AGA + vLLM å®Œæ•´ç³»ç»Ÿï¼Œè¯·å‚é˜… [DKI+AGA å®Œæ•´éƒ¨ç½²æŒ‡å—](docs/DKI_AGA_Complete_Deployment_Guide.md)ï¼ŒåŒ…å«è¯¦ç»†çš„ç¯å¢ƒé…ç½®ã€æ¨¡å‹ä¸‹è½½ã€æœåŠ¡å¯åŠ¨å’Œæµ‹è¯•æ­¥éª¤ã€‚

### å®‰è£…

```bash
# å…‹éš†ä»“åº“
cd DKI

# å®‰è£…ï¼ˆåˆ›å»ºè™šæ‹Ÿç¯å¢ƒã€å®‰è£…ä¾èµ–ã€åˆå§‹åŒ–æ•°æ®åº“ï¼‰
# Windows:
scripts\setup.bat

# Linux/Mac:
chmod +x scripts/*.sh
./scripts/setup.sh
```

### ä¸Šå±‚åº”ç”¨é›†æˆ (æ¨èæ–¹å¼)

DKI ä½œä¸º LLM æ’ä»¶ï¼Œä¸Šå±‚åº”ç”¨åªéœ€ï¼š

1. **æä¾›é€‚é…å™¨é…ç½®æ–‡ä»¶** - æŒ‡å®šæ•°æ®åº“è¿æ¥å’Œå­—æ®µæ˜ å°„
2. **åˆ é™¤ RAG/Prompt å·¥ç¨‹ä»£ç ** - DKI è‡ªåŠ¨å¤„ç†
3. **ä¼ é€’ user_id + åŸå§‹è¾“å…¥** - æ— éœ€ä»»ä½• prompt æ„é€ 

```python
from dki.core.dki_plugin import DKIPlugin
from dki.models.vllm_adapter import VLLMAdapter

# 1. åˆå§‹åŒ– LLM é€‚é…å™¨
model_adapter = VLLMAdapter(model_name="Qwen/Qwen2-7B-Instruct")

# 2. ä»é…ç½®æ–‡ä»¶åˆ›å»º DKI æ’ä»¶ (æ¨è)
# ä¸Šå±‚åº”ç”¨åªéœ€æä¾›é…ç½®æ–‡ä»¶ï¼Œæ— éœ€å®ç°ä»»ä½•æ¥å£
dki = await DKIPlugin.from_config(
    model_adapter=model_adapter,
    adapter_config_path="config/adapter_config.yaml",  # æŒ‡å®šæ•°æ®åº“è¿æ¥å’Œå­—æ®µæ˜ å°„
)

# 3. è°ƒç”¨ DKI - åªéœ€ä¼ é€’ user_id å’ŒåŸå§‹è¾“å…¥
# DKI ä¼šè‡ªåŠ¨:
# - é€šè¿‡é€‚é…å™¨è¯»å–ä¸Šå±‚åº”ç”¨æ•°æ®åº“çš„ç”¨æˆ·åå¥½ â†’ K/V æ³¨å…¥
# - é€šè¿‡é€‚é…å™¨æ£€ç´¢ç›¸å…³å†å²æ¶ˆæ¯ â†’ åç¼€æç¤ºè¯
response = await dki.chat(
    query="ä»Šæ™šæƒ³æ‰¾ä¸€å®¶é¤å…ï¼Œæœ‰ä»€ä¹ˆæ–°æ¨èå—ï¼Ÿ",  # åŸå§‹ç”¨æˆ·è¾“å…¥ï¼Œæ— éœ€ä»»ä½• prompt æ„é€ 
    user_id="user_001",   # ç”¨æˆ·æ ‡è¯† (DKI ç”¨äºè¯»å–åå¥½å’Œå†å²)
    session_id="session_001",  # ä¼šè¯æ ‡è¯† (DKI ç”¨äºè¯»å–ä¼šè¯å†å²)
)

print(response.text)
# è¾“å‡ºä¼šè€ƒè™‘ï¼š
# - ç´ é£Ÿåå¥½ï¼ˆéšå¼ï¼Œæ¥è‡ª K/V æ³¨å…¥ï¼‰
# - ä¹‹å‰çš„é¤å…è®¿é—®ï¼ˆæ˜¾å¼ï¼Œæ¥è‡ªå†å²åç¼€ï¼‰
# - åŒ—äº¬ä½ç½®ï¼ˆéšå¼ï¼Œæ¥è‡ª K/V æ³¨å…¥ï¼‰

# ç›‘æ§æ•°æ®
print(f"æ³¨å…¥å¯ç”¨: {response.metadata.injection_enabled}")
print(f"Alphaå€¼: {response.metadata.alpha}")
print(f"åå¥½ tokens: {response.metadata.preference_tokens}")
print(f"å†å² tokens: {response.metadata.history_tokens}")
print(f"ç¼“å­˜å‘½ä¸­: {response.metadata.preference_cache_hit}")
print(f"å»¶è¿Ÿ: {response.metadata.latency_ms}ms")
```

### é€‚é…å™¨é…ç½®ç¤ºä¾‹

åˆ›å»º `config/adapter_config.yaml`ï¼ŒæŒ‡å®šå¦‚ä½•è¿æ¥ä¸Šå±‚åº”ç”¨çš„æ•°æ®åº“ï¼š

```yaml
user_adapter:
    # æ•°æ®åº“è¿æ¥ (è¿æ¥åˆ°ä¸Šå±‚åº”ç”¨çš„æ•°æ®åº“)
    database:
        type: postgresql # postgresql | mysql | sqlite
        host: localhost
        port: 5432
        database: my_app_db # ä¸Šå±‚åº”ç”¨çš„æ•°æ®åº“
        username: user
        password: pass

    # ç”¨æˆ·åå¥½è¡¨æ˜ å°„ (æ˜ å°„åˆ°ä¸Šå±‚åº”ç”¨çš„è¡¨ç»“æ„)
    preferences:
        table: user_preferences # ä¸Šå±‚åº”ç”¨çš„è¡¨å
        fields:
            user_id: user_id # ä¸Šå±‚åº”ç”¨çš„å­—æ®µå
            preference_text: content
            preference_type: type
            priority: priority

    # æ¶ˆæ¯è¡¨æ˜ å°„
    messages:
        table: chat_messages
        fields:
            message_id: id
            session_id: session_id
            user_id: user_id
            role: role
            content: content
            timestamp: created_at

        # JSON å†…å®¹è§£æ (é‡è¦!)
        # å¦‚æœ content å­—æ®µå­˜å‚¨çš„æ˜¯ JSON å­—ç¬¦ä¸² (å¦‚ AI åŸå§‹å“åº”)
        # å¯ä»¥æŒ‡å®š JSON key æ¥æå–å®é™…æ–‡æœ¬å†…å®¹
        #
        # åœºæ™¯: ä¸Šå±‚åº”ç”¨ç›´æ¥å­˜å‚¨ AI å“åº”ï¼Œcontent å­—æ®µå¯èƒ½æ˜¯:
        #   '{"text": "æ¨èå·èœé¦†", "model": "gpt-4", "tokens": 100}'
        #
        # é…ç½® content_json_key: "text" åï¼ŒDKI ä¼šè‡ªåŠ¨æå– "æ¨èå·èœé¦†"
        # å¦‚æœ JSON è§£æå¤±è´¥æˆ– key ä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨åŸå§‹å†…å®¹ (å®‰å…¨å›é€€)
        content_json_key:
            null # è®¾ç½®ä¸º JSON key åç§°ï¼Œå¦‚ "text", "content"
            # æ”¯æŒåµŒå¥—: "data.text", "choices.0.message.content"

    # å‘é‡æ£€ç´¢é…ç½® (æ”¯æŒåŠ¨æ€å‘é‡å¤„ç†)
    vector_search:
        type: dynamic # pgvector | faiss | dynamic
        dynamic:
            strategy: hybrid # lazy | batch | hybrid (BM25 + embedding)
```

#### JSON å†…å®¹è§£æè¯´æ˜

è®¸å¤šåº”ç”¨ç›´æ¥å°† AI çš„åŸå§‹å“åº”å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œ`content` å­—æ®µå¯èƒ½æ˜¯ JSON å­—ç¬¦ä¸²ï¼š

```json
{
    "text": "æ¨èæ‚¨å»å·èœé¦†",
    "model": "gpt-4",
    "tokens": 50,
    "finish_reason": "stop"
}
```

é€šè¿‡é…ç½® `content_json_key`ï¼ŒDKI å¯ä»¥è‡ªåŠ¨æå–å®é™…çš„æ–‡æœ¬å†…å®¹ï¼š

| é…ç½®å€¼                        | JSON æ•°æ®                      | æå–ç»“æœ     |
| ----------------------------- | ------------------------------ | ------------ |
| `"text"`                      | `{"text": "Hello"}`            | `"Hello"`    |
| `"data.text"`                 | `{"data": {"text": "Nested"}}` | `"Nested"`   |
| `"choices.0.message.content"` | OpenAI æ ¼å¼å“åº”                | å®é™…å›å¤å†…å®¹ |

**å®‰å…¨å›é€€**ï¼šå¦‚æœ JSON è§£æå¤±è´¥æˆ–æŒ‡å®šçš„ key ä¸å­˜åœ¨ï¼ŒDKI ä¼šä½¿ç”¨åŸå§‹å†…å®¹ï¼Œä¸ä¼šæŠ¥é”™ã€‚

### Chat UI ç¤ºä¾‹ç•Œé¢

DKI æä¾›äº†ä¸€ä¸ªåŸºäº Vue3 + Element Plus çš„ç¤ºä¾‹ Chat UIï¼Œç”¨äºæ¼”ç¤º DKI é›†æˆï¼š

```bash
# åŒæ—¶å¯åŠ¨å‰åç«¯
python start_dev.py

# ä»…å¯åŠ¨åç«¯
python start_dev.py backend

# ä»…å¯åŠ¨å‰ç«¯
python start_dev.py frontend
```

**UI åŠŸèƒ½ç‰¹æ€§**ï¼š

-   ğŸ” ç”¨æˆ·ç™»å½•/æ³¨å†Œ
-   ğŸ’¬ æ”¯æŒ Markdown æ¸²æŸ“çš„èŠå¤©ç•Œé¢
-   âš™ï¸ ç”¨æˆ·åå¥½ç®¡ç†ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
-   ğŸ“Š ä¼šè¯å†å²ç®¡ç†
-   ğŸ“ˆ ç³»ç»Ÿç»Ÿè®¡ç›‘æ§ï¼ˆéœ€ç®¡ç†å‘˜å¯†ç ï¼‰
-   ğŸ¨ æµ…è‰²/æ·±è‰²ä¸»é¢˜åˆ‡æ¢

**æ³¨æ„**ï¼šChat UI æ˜¯ä¸€ä¸ª**ç¤ºä¾‹åº”ç”¨**ï¼Œç”¨äºæ¼”ç¤º DKI é›†æˆã€‚DKI çš„é€‚é…å™¨ä¼šè¯»å– Chat UI çš„æ•°æ®åº“æ¥è·å–ç”¨æˆ·åå¥½å’Œå†å²æ¶ˆæ¯ã€‚

**ç»Ÿè®¡é¡µé¢é‰´æƒ**ï¼š
ç»Ÿè®¡é¡µé¢ä½¿ç”¨ç®€å•å¯†ç ä¿æŠ¤ï¼ˆéç”Ÿäº§æ ‡å‡†ï¼‰ï¼Œå¯åœ¨é…ç½®ä¸­è®¾ç½®ï¼š

```bash
# ç¯å¢ƒå˜é‡
VITE_STATS_PASSWORD=your_password
```

### ç›‘æ§ API

DKI æä¾›ç›‘æ§ API ç”¨äºæŸ¥çœ‹å†…éƒ¨å·¥ä½œçŠ¶æ€ï¼š

```python
# è·å–ç»Ÿè®¡æ•°æ®
stats = dki.get_stats()
print(f"æ€»è¯·æ±‚æ•°: {stats['total_requests']}")
print(f"æ³¨å…¥ç‡: {stats['injection_rate']:.2%}")
print(f"ç¼“å­˜å‘½ä¸­ç‡: {stats['cache_hit_rate']:.2%}")
print(f"å¹³å‡å»¶è¿Ÿ: {stats['avg_latency_ms']:.1f}ms")

# è·å–æ³¨å…¥æ—¥å¿—
logs = dki.get_injection_logs(limit=10)
for log in logs:
    print(f"[{log['timestamp']}] alpha={log['alpha']:.2f}, enabled={log['injection_enabled']}")
```

REST API ç«¯ç‚¹ï¼š

-   `GET /v1/dki/info` - è·å– DKI æ’ä»¶çŠ¶æ€
-   `POST /v1/dki/chat` - DKI å¢å¼ºèŠå¤© (ä¸Šå±‚åº”ç”¨è°ƒç”¨æ­¤æ¥å£)

## ğŸ“ é¡¹ç›®ç»“æ„

```
DKI/
â”œâ”€â”€ config/                              # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ config.yaml                      # â­ ä¸»é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ adapter_config.example.yaml      # â­ é€‚é…å™¨é…ç½®ç¤ºä¾‹
â”‚   â”œâ”€â”€ memory_trigger.yaml              # Memory Trigger é…ç½®
â”‚   â””â”€â”€ reference_resolver.yaml          # Reference Resolver é…ç½®
â”‚
â”œâ”€â”€ dki/                                 # æ ¸å¿ƒä»£ç ç›®å½•
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                            # â­ æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ dki_plugin.py                # â­ DKI æ’ä»¶æ ¸å¿ƒ (å…¥å£)
â”‚   â”‚   â”œâ”€â”€ dki_system.py                # DKI ç³»ç»Ÿå°è£…
â”‚   â”‚   â”œâ”€â”€ architecture.py              # æ¶æ„å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ plugin_interface.py          # æ’ä»¶æ¥å£å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ memory_router.py             # åŸºäº FAISS çš„å‘é‡æ£€ç´¢
â”‚   â”‚   â”œâ”€â”€ embedding_service.py         # åµŒå…¥è®¡ç®—æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ rag_system.py               # RAG åŸºçº¿ (å¯¹æ¯”å®éªŒç”¨)
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ injection/                   # â­ æ³¨å…¥ç­–ç•¥
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â””â”€â”€ full_attention_injector.py  # Full Attention ç­–ç•¥ (ç ”ç©¶)
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ components/                  # â­ æ ¸å¿ƒç®—æ³•ç»„ä»¶
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ memory_influence_scaling.py    # MIS - è®°å¿†å½±å“ç¼©æ”¾
â”‚   â”‚       â”œâ”€â”€ query_conditioned_projection.py  # QCP - æŸ¥è¯¢æ¡ä»¶æŠ•å½±
â”‚   â”‚       â”œâ”€â”€ dual_factor_gating.py          # åŒå› å­é—¨æ§å†³ç­–
â”‚   â”‚       â”œâ”€â”€ hybrid_injector.py             # æ··åˆæ³¨å…¥å™¨
â”‚   â”‚       â”œâ”€â”€ memory_trigger.py              # â­ è®°å¿†è§¦å‘æ£€æµ‹
â”‚   â”‚       â”œâ”€â”€ reference_resolver.py          # â­ æŒ‡ä»£è§£æå™¨
â”‚   â”‚       â”œâ”€â”€ attention_budget.py            # æ³¨æ„åŠ›é¢„ç®—è¿½è¸ª
â”‚   â”‚       â”œâ”€â”€ session_kv_cache.py            # ä¼šè¯çº§ K/V ç¼“å­˜
â”‚   â”‚       â”œâ”€â”€ tiered_kv_cache.py             # L1/L2/L3/L4 åˆ†å±‚ç¼“å­˜
â”‚   â”‚       â””â”€â”€ position_remapper.py           # ä½ç½®ç¼–ç é‡æ˜ å°„ (RoPE/ALiBi)
â”‚   â”‚
â”‚   â”œâ”€â”€ adapters/                        # â­ å¤–éƒ¨æ•°æ®é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py                      # é€‚é…å™¨æŠ½è±¡åŸºç±»
â”‚   â”‚   â”œâ”€â”€ config_driven_adapter.py     # â­ é…ç½®é©±åŠ¨é€‚é…å™¨ (æ ¸å¿ƒ)
â”‚   â”‚   â”œâ”€â”€ factory.py                   # é€‚é…å™¨å·¥å‚
â”‚   â”‚   â”œâ”€â”€ example_adapter.py           # ç¤ºä¾‹é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ memory_adapter.py            # å†…å­˜é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ postgresql_adapter.py        # PostgreSQL é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ mysql_adapter.py             # MySQL é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ mongodb_adapter.py           # MongoDB é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ redis_adapter.py             # Redis é€‚é…å™¨
â”‚   â”‚   â””â”€â”€ rest_adapter.py              # REST API é€‚é…å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ attention/                       # â­ FlashAttention é›†æˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py                    # FlashAttention é…ç½®
â”‚   â”‚   â”œâ”€â”€ backend.py                   # åç«¯æ£€æµ‹ (FA3/FA2/Standard)
â”‚   â”‚   â”œâ”€â”€ kv_injection.py              # ä¼˜åŒ–çš„ K/V æ³¨å…¥è®¡ç®—
â”‚   â”‚   â””â”€â”€ profiler.py                  # æ€§èƒ½åˆ†æå™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                             # REST API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ dki_routes.py                # â­ DKI èŠå¤© API
â”‚   â”‚   â”œâ”€â”€ visualization_routes.py      # â­ æ³¨å…¥å¯è§†åŒ– API
â”‚   â”‚   â”œâ”€â”€ stats_routes.py              # ç»Ÿè®¡æ•°æ® API
â”‚   â”‚   â”œâ”€â”€ monitoring_routes.py         # ç›‘æ§ API
â”‚   â”‚   â”œâ”€â”€ auth_routes.py               # è®¤è¯ API
â”‚   â”‚   â”œâ”€â”€ session_routes.py            # ä¼šè¯ç®¡ç† API
â”‚   â”‚   â”œâ”€â”€ preference_routes.py         # åå¥½ç®¡ç† API
â”‚   â”‚   â”œâ”€â”€ routes.py                    # è·¯ç”±æ³¨å†Œ
â”‚   â”‚   â”œâ”€â”€ dependencies.py              # ä¾èµ–æ³¨å…¥
â”‚   â”‚   â””â”€â”€ models.py                    # API æ•°æ®æ¨¡å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                          # LLM æ¨¡å‹é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ factory.py                   # æ¨¡å‹å·¥å‚
â”‚   â”‚   â”œâ”€â”€ base.py                      # åŸºç¡€é€‚é…å™¨ (å« FlashAttention)
â”‚   â”‚   â”œâ”€â”€ vllm_adapter.py              # vLLM é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ llama_adapter.py             # LLaMA é€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ deepseek_adapter.py          # DeepSeek é€‚é…å™¨
â”‚   â”‚   â””â”€â”€ glm_adapter.py              # GLM é€‚é…å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ cache/                           # â­ ç¼“å­˜ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ preference_cache.py          # â­ åå¥½ç¼“å­˜ç®¡ç† (L1+L2)
â”‚   â”‚   â”œâ”€â”€ redis_client.py              # â­ Redis åˆ†å¸ƒå¼ç¼“å­˜å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ non_vectorized_handler.py    # åŠ¨æ€å‘é‡å¤„ç† (BM25+Embedding)
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                          # é…ç½®åŠ è½½
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ config_loader.py             # YAML é…ç½®åŠ è½½å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ database/                        # æ•°æ®åº“
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ models.py                    # SQLAlchemy ORM æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ connection.py                # æ•°æ®åº“è¿æ¥ç®¡ç†
â”‚   â”‚   â””â”€â”€ repository.py               # æ•°æ®ä»“åº“
â”‚   â”‚
â”‚   â”œâ”€â”€ experiment/                      # å®éªŒç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ runner.py                    # å®éªŒè¿è¡Œå™¨ (DKI/RAG/Baseline)
â”‚   â”‚   â”œâ”€â”€ metrics.py                   # è¯„ä¼°æŒ‡æ ‡ (å¬å›/å¹»è§‰/å»¶è¿Ÿ)
â”‚   â”‚   â””â”€â”€ data_generator.py            # æµ‹è¯•æ•°æ®ç”Ÿæˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ example_app/                     # ç¤ºä¾‹é›†æˆåº”ç”¨
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ app.py                       # ç¤ºä¾‹ FastAPI åº”ç”¨
â”‚   â”‚   â”œâ”€â”€ main.py                      # ç¤ºä¾‹å…¥å£
â”‚   â”‚   â””â”€â”€ service.py                   # ç¤ºä¾‹ä¸šåŠ¡é€»è¾‘
â”‚   â”‚
â”‚   â””â”€â”€ web/                             # Web åº”ç”¨
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ app.py                       # FastAPI ä¸»åº”ç”¨
â”‚
â”œâ”€â”€ ui/                                  # â­ Vue3 ç¤ºä¾‹å‰ç«¯ç•Œé¢
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.vue                      # åº”ç”¨æ ¹ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ main.ts                      # å…¥å£æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ vite-env.d.ts
â”‚   â”‚   â”œâ”€â”€ views/                       # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatView.vue             # ğŸ’¬ èŠå¤©é¡µé¢ (Markdown æ¸²æŸ“)
â”‚   â”‚   â”‚   â”œâ”€â”€ InjectionVizView.vue     # ğŸ“Š æ³¨å…¥å¯è§†åŒ–é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ PreferencesView.vue      # âš™ï¸ åå¥½ç®¡ç†é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ SessionsView.vue         # ğŸ“‹ ä¼šè¯ç®¡ç†é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ StatsView.vue            # ğŸ“ˆ ç»Ÿè®¡ç›‘æ§é¡µé¢
â”‚   â”‚   â”‚   â””â”€â”€ LoginView.vue            # ğŸ” ç™»å½•é¡µé¢
â”‚   â”‚   â”œâ”€â”€ components/                  # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatInput.vue            # èŠå¤©è¾“å…¥æ¡†
â”‚   â”‚   â”‚   â”œâ”€â”€ MessageItem.vue          # æ¶ˆæ¯æ°”æ³¡
â”‚   â”‚   â”‚   â””â”€â”€ SettingsDialog.vue       # è®¾ç½®å¼¹çª—
â”‚   â”‚   â”œâ”€â”€ layouts/
â”‚   â”‚   â”‚   â””â”€â”€ MainLayout.vue           # ä¸»å¸ƒå±€
â”‚   â”‚   â”œâ”€â”€ stores/                      # Pinia çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts                  # è®¤è¯çŠ¶æ€
â”‚   â”‚   â”‚   â”œâ”€â”€ chat.ts                  # èŠå¤©çŠ¶æ€
â”‚   â”‚   â”‚   â”œâ”€â”€ preferences.ts           # åå¥½çŠ¶æ€
â”‚   â”‚   â”‚   â”œâ”€â”€ settings.ts              # è®¾ç½®çŠ¶æ€
â”‚   â”‚   â”‚   â””â”€â”€ statsAuth.ts             # ç»Ÿè®¡é‰´æƒçŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ api.ts                   # API æœåŠ¡å°è£…
â”‚   â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                 # Vue Router è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                 # å‰ç«¯é…ç½®
â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                 # TypeScript ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â””â”€â”€ markdown.ts              # Markdown æ¸²æŸ“å·¥å…·
â”‚   â”‚   â””â”€â”€ assets/styles/
â”‚   â”‚       â”œâ”€â”€ main.scss                # ä¸»æ ·å¼
â”‚   â”‚       â””â”€â”€ variables.scss           # æ ·å¼å˜é‡
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ tsconfig.node.json
â”‚   â”œâ”€â”€ env.example
â”‚   â””â”€â”€ README.md
â”‚
â”œâ”€â”€ docs/                                # ğŸ“š æ–‡æ¡£
â”‚   â”œâ”€â”€ DKI_AGA_Complete_Deployment_Guide.md  # â­ DKI+AGA å®Œæ•´éƒ¨ç½²æŒ‡å—
â”‚   â”œâ”€â”€ DKI_Architecture_Diagrams.md     # â­ ç³»ç»Ÿæ¶æ„å›¾å’Œæµç¨‹å›¾
â”‚   â”œâ”€â”€ DKI_Optimization_Roadmap.md      # â­ åç»­ä¼˜åŒ–æ–¹æ¡ˆä¸äº§å“åŒ–åˆ†æ
â”‚   â”œâ”€â”€ Integration_Guide.md             # é›†æˆæŒ‡å—
â”‚   â”œâ”€â”€ Dynamic_Vector_Search.md         # åŠ¨æ€å‘é‡æ£€ç´¢è¯´æ˜
â”‚   â”œâ”€â”€ FlashAttention3_Integration.md   # FlashAttention é›†æˆæ–¹æ¡ˆ
â”‚   â”œâ”€â”€ DKI_ç”¨æˆ·è®°å¿†æ³¨å…¥å®Œæ•´ç³»ç»Ÿæ–¹æ¡ˆ.md    # è®°å¿†æ³¨å…¥å®Œæ•´æ–¹æ¡ˆ
â”‚   â”œâ”€â”€ DKI_Plugin_Architecture.md       # æ’ä»¶æ¶æ„æ–‡æ¡£
â”‚   â”œâ”€â”€ DKIå®Œæ•´ç”Ÿäº§çº§æ¶æ„è®¾è®¡.md           # å®Œæ•´ç”Ÿäº§çº§æ¶æ„è®¾è®¡
â”‚   â”œâ”€â”€ DKI_Usage_Guide.md              # ä½¿ç”¨æŒ‡å—
â”‚   â”œâ”€â”€ DKI å®šä½è¯´æ˜.md                  # DKI å®šä½è¯´æ˜
â”‚   â”œâ”€â”€ DKIæ¼”åŒ–è·¯å¾„çš„æ€è€ƒ.md              # æ¼”åŒ–è·¯å¾„åˆ†æ
â”‚   â”œâ”€â”€ Chat_UI_è®¾è®¡æ–¹æ¡ˆ.md              # UI è®¾è®¡æ–¹æ¡ˆ
â”‚   â”œâ”€â”€ ç”Ÿäº§ç³»ç»Ÿæ”¹é€ æ–¹æ¡ˆ.md               # ç”Ÿäº§æ”¹é€ æ–¹æ¡ˆ
â”‚   â””â”€â”€ ç³»ç»Ÿä¿®æ­£ä¼˜åŒ–å»ºè®®.md               # ç³»ç»Ÿä¿®æ­£å»ºè®®
â”‚
â”œâ”€â”€ tests/                               # ğŸ§ª æµ‹è¯•
â”‚   â”œâ”€â”€ unit/                            # å•å…ƒæµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_dki_plugin.py           # DKI æ’ä»¶æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_config_driven_adapter.py # é€‚é…å™¨æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_json_content_extraction.py # JSON è§£ææµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_memory_trigger.py       # è®°å¿†è§¦å‘æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_reference_resolver.py   # æŒ‡ä»£è§£ææµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_flash_attention.py      # FlashAttention æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_redis_cache.py          # Redis ç¼“å­˜æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ components/                  # ç»„ä»¶å•å…ƒæµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_attention_budget.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_dual_factor_gating.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_memory_influence_scaling.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_position_remapper.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_query_conditioned_projection.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_session_kv_cache.py
â”‚   â”‚   â”‚   â””â”€â”€ test_tiered_kv_cache.py
â”‚   â”‚   â”œâ”€â”€ core/                        # æ ¸å¿ƒæ¨¡å—æµ‹è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ test_dki_system.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_embedding_service.py
â”‚   â”‚   â”‚   â”œâ”€â”€ test_memory_router.py
â”‚   â”‚   â”‚   â””â”€â”€ test_rag_baseline.py
â”‚   â”‚   â””â”€â”€ database/                    # æ•°æ®åº“æµ‹è¯•
â”‚   â”‚       â”œâ”€â”€ test_connection.py
â”‚   â”‚       â””â”€â”€ test_repository.py
â”‚   â”œâ”€â”€ integration/                     # é›†æˆæµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_dki_chat_flow.py
â”‚   â”‚   â”œâ”€â”€ test_dki_vs_rag.py
â”‚   â”‚   â”œâ”€â”€ test_kv_injection_flow.py
â”‚   â”‚   â””â”€â”€ test_cache_eviction_flow.py
â”‚   â”œâ”€â”€ behavior/                        # è¡Œä¸ºæµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ test_budget_enforcement.py
â”‚   â”‚   â”œâ”€â”€ test_influence_monotonicity.py
â”‚   â”‚   â””â”€â”€ test_injection_isolation.py
â”‚   â””â”€â”€ fixtures/                        # æµ‹è¯•å¤¹å…·
â”‚       â”œâ”€â”€ fake_attention.py
â”‚       â”œâ”€â”€ fake_embeddings.py
â”‚       â”œâ”€â”€ fake_model.py
â”‚       â””â”€â”€ sample_memories.py
â”‚
â”œâ”€â”€ scripts/                             # è„šæœ¬
â”‚   â”œâ”€â”€ setup.bat / setup.sh             # å®‰è£…è„šæœ¬
â”‚   â”œâ”€â”€ start.bat / start.sh             # å¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ init_db.sql                      # æ•°æ®åº“åˆå§‹åŒ–
â”‚
â”œâ”€â”€ start_dev.py                         # â­ å¼€å‘å¯åŠ¨è„šæœ¬ (å‰åç«¯åŒæ—¶)
â”œâ”€â”€ main.py                              # â­ ä¸»å…¥å£ (CLI)
â”œâ”€â”€ requirements.txt                     # Python ä¾èµ–
â”œâ”€â”€ setup.py                             # å®‰è£…é…ç½®
â”œâ”€â”€ QUICKSTART.md                        # å¿«é€Ÿå¼€å§‹
â”œâ”€â”€ README_CN.md                         # ä¸­æ–‡æ–‡æ¡£
â””â”€â”€ README.md                            # è‹±æ–‡æ–‡æ¡£
```

## ğŸ“Š é¡¹ç›®çŠ¶æ€

| æ¨¡å—                 | çŠ¶æ€      | è¯´æ˜                              |
| -------------------- | --------- | --------------------------------- |
| DKI æ ¸å¿ƒæ’ä»¶         | âœ… å®Œæˆ   | K/V æ³¨å…¥ã€æ··åˆç­–ç•¥ã€é—¨æ§å†³ç­–      |
| Full Attention ç­–ç•¥  | âš ï¸ å¼ƒç”¨   | å·²å¼ƒç”¨ï¼šé•¿å†å²ä¿¡æ¯åœºæ™¯å±€é™æ€§      |
| Recall v4 è®°å¿†å¬å›   | âœ… å®Œæˆ   | å¤šä¿¡å·æ£€ç´¢ + åŠ¨æ€æ‘˜è¦ + äº‹å®è¡¥å……  |
| é…ç½®é©±åŠ¨é€‚é…å™¨       | âœ… å®Œæˆ   | SQLAlchemy åŠ¨æ€è¡¨æ˜ å°„             |
| JSON å†…å®¹æå–        | âœ… å®Œæˆ   | è‡ªåŠ¨è§£æ JSON æ ¼å¼çš„ content å­—æ®µ |
| Memory Trigger       | âœ… å®Œæˆ   | è®°å¿†è§¦å‘æ£€æµ‹ï¼Œå¯é…ç½®è§„åˆ™          |
| Reference Resolver   | âœ… å®Œæˆ   | æŒ‡ä»£è§£æï¼Œå¯é…ç½®å¬å›è½®æ•°          |
| Redis åˆ†å¸ƒå¼ç¼“å­˜     | âœ… å®Œæˆ   | L1+L2 ç¼“å­˜ï¼Œå¤šå®ä¾‹éƒ¨ç½²æ”¯æŒ        |
| FlashAttention é›†æˆ  | âœ… å®Œæˆ   | FA3/FA2 è‡ªåŠ¨æ£€æµ‹ï¼Œä¼˜é›…é™çº§        |
| æ³¨å…¥å¯è§†åŒ–           | âœ… å®Œæˆ   | æµç¨‹å›¾ã€Token åˆ†å¸ƒã€å†å²è®°å½•      |
| Vue3 ç¤ºä¾‹ UI         | âœ… å®Œæˆ   | èŠå¤©ã€åå¥½ç®¡ç†ã€ç»Ÿè®¡ã€å¯è§†åŒ–      |
| ç›‘æ§ API             | âœ… å®Œæˆ   | ç»Ÿè®¡ã€æ—¥å¿—ã€å¥åº·æ£€æŸ¥              |
| æ¶æ„å›¾æ–‡æ¡£           | âœ… å®Œæˆ   | ç³»ç»Ÿæ¶æ„å›¾ã€æ³¨å…¥æµç¨‹å›¾            |
| å•å…ƒæµ‹è¯•             | âœ… å®Œæˆ   | æ ¸å¿ƒç»„ä»¶æµ‹è¯•è¦†ç›–                  |
| æ³¨æ„åŠ›çƒ­åŠ›å›¾å¯è§†åŒ–   | ğŸ”„ è§„åˆ’ä¸­ | è°ƒè¯•ç”¨æ³¨æ„åŠ›æƒé‡å¯è§†åŒ–            |
| LangChain/LlamaIndex | ğŸ”„ è§„åˆ’ä¸­ | ç”Ÿæ€é›†æˆ                          |
| å¤šæ¨¡æ€è®°å¿†           | ğŸ“‹ å¾…å®š   | å›¾åƒ/éŸ³é¢‘è®°å¿†æ”¯æŒ                 |

## âš™ï¸ é…ç½®

### DKI ä¸»é…ç½®

ç¼–è¾‘ `config/config.yaml`:

```yaml
# æ¨¡å‹å¼•æ“
model:
    default_engine: "vllm" # vllm, llama, deepseek, glm
    engines:
        vllm:
            model_name: "Qwen/Qwen2-7B-Instruct"
            tensor_parallel_size: 1

# DKI æ’ä»¶è®¾ç½®
dki:
    enabled: true
    version: "2.5"

    # æ··åˆæ³¨å…¥ç­–ç•¥
    hybrid_injection:
        enabled: true
        language: "cn" # en | cn

        # åå¥½ï¼šK/V æ³¨å…¥ï¼ˆAttention Hookï¼Œè´Ÿä½ç½®ï¼‰
        preference:
            enabled: true
            position_strategy: "negative"
            alpha: 0.4 # è¾ƒä½ç”¨äºèƒŒæ™¯å½±å“
            max_tokens: 200

        # å†å²ï¼šåç¼€æç¤ºè¯ï¼ˆæ­£ä½ç½®ï¼‰
        history:
            enabled: true
            method: "suffix_prompt"
            max_tokens: 2000
            max_messages: 10

    # é—¨æ§ï¼šç›¸å…³æ€§é©±åŠ¨ï¼Œç†µè°ƒåˆ¶
    gating:
        relevance_threshold: 0.7
        entropy_ceiling: 1.0
        entropy_floor: 0.5

    # å®‰å…¨è®¾ç½®
    safety:
        max_alpha: 0.8
        fallback_on_error: true
        audit_logging: true
```

### é€‚é…å™¨é…ç½® (æ ¸å¿ƒ)

åˆ›å»º `config/adapter_config.yaml`ï¼Œé…ç½®å¦‚ä½•è¿æ¥ä¸Šå±‚åº”ç”¨çš„æ•°æ®åº“ï¼š

```yaml
user_adapter:
    # æ•°æ®åº“è¿æ¥ - è¿æ¥åˆ°ä¸Šå±‚åº”ç”¨çš„æ•°æ®åº“
    database:
        type: postgresql # postgresql | mysql | sqlite
        host: localhost
        port: 5432
        database: my_app_db # ä¸Šå±‚åº”ç”¨çš„æ•°æ®åº“å
        username: user
        password: pass
        pool_size: 5

    # ç”¨æˆ·åå¥½è¡¨æ˜ å°„ - æ˜ å°„åˆ°ä¸Šå±‚åº”ç”¨çš„è¡¨ç»“æ„
    preferences:
        table: user_preferences # ä¸Šå±‚åº”ç”¨çš„åå¥½è¡¨å
        fields:
            user_id: user_id # å­—æ®µæ˜ å°„: DKIå­—æ®µ -> ä¸Šå±‚åº”ç”¨å­—æ®µ
            preference_text: content
            preference_type: type
            priority: priority
            created_at: created_at
        filters:
            is_active: true # é¢å¤–è¿‡æ»¤æ¡ä»¶

    # æ¶ˆæ¯è¡¨æ˜ å°„
    messages:
        table: chat_messages # ä¸Šå±‚åº”ç”¨çš„æ¶ˆæ¯è¡¨å
        fields:
            message_id: id
            session_id: session_id
            user_id: user_id
            role: role
            content: content
            timestamp: created_at
            embedding: embedding # å‘é‡å­—æ®µ (å¯é€‰)

    # å‘é‡æ£€ç´¢é…ç½®
    vector_search:
        enabled: true
        type: dynamic # pgvector | faiss | dynamic | none

        # åŠ¨æ€å‘é‡å¤„ç† (æ— é¢„è®¡ç®—å‘é‡æ—¶ä½¿ç”¨)
        dynamic:
            strategy: hybrid # lazy | batch | hybrid
            # hybrid = BM25 åˆç­› + embedding é‡æ’åº

        # æ£€ç´¢å‚æ•°
        top_k: 10
        similarity_threshold: 0.5

    # ç¼“å­˜é…ç½®
    cache_enabled: true
    cache_ttl: 300 # 5 åˆ†é’Ÿ
```

### é…ç½®è¯´æ˜

**é€‚é…å™¨é…ç½®çš„æ ¸å¿ƒç†å¿µ**ï¼š

-   ä¸Šå±‚åº”ç”¨**æ— éœ€å®ç°ä»»ä½•æ¥å£**
-   åªéœ€æä¾›é…ç½®æ–‡ä»¶ï¼ŒæŒ‡å®šæ•°æ®åº“è¿æ¥å’Œå­—æ®µæ˜ å°„
-   DKI ä½¿ç”¨ SQLAlchemy åŠ¨æ€åå°„è¡¨ç»“æ„
-   æ”¯æŒ PostgreSQLã€MySQLã€SQLite ç­‰ä¸»æµæ•°æ®åº“

## ğŸ“Š å®éªŒ

### ç”Ÿæˆæµ‹è¯•æ•°æ®

```bash
python -m dki.experiment.data_generator
```

### è¿è¡Œå¯¹æ¯”å®éªŒ

```python
from dki.experiment.runner import ExperimentRunner, ExperimentConfig

runner = ExperimentRunner()
config = ExperimentConfig(
    name="DKI vs RAG å¯¹æ¯”",
    modes=["dki", "rag", "baseline"],
    datasets=["persona_chat", "memory_qa"],
    max_samples=100
)

results = runner.run_experiment(config)
```

### Alpha æ•æ„Ÿæ€§åˆ†æ

```python
results = runner.run_alpha_sensitivity(
    alpha_values=[0.0, 0.2, 0.4, 0.6, 0.8, 1.0]
)
```

## ğŸ“ˆ API å‚è€ƒ

### DKI æ’ä»¶ API

| ç«¯ç‚¹           | æ–¹æ³• | æè¿°                              |
| -------------- | ---- | --------------------------------- |
| `/v1/dki/chat` | POST | DKI å¢å¼ºèŠå¤© (ä¸Šå±‚åº”ç”¨è°ƒç”¨æ­¤æ¥å£) |
| `/v1/dki/info` | GET  | è·å– DKI æ’ä»¶çŠ¶æ€                 |

### ç›‘æ§ API

| ç«¯ç‚¹             | æ–¹æ³• | æè¿°              |
| ---------------- | ---- | ----------------- |
| `/api/stats`     | GET  | è·å–ç³»ç»Ÿç»Ÿè®¡ä¿¡æ¯  |
| `/api/stats/dki` | GET  | è·å– DKI ç»Ÿè®¡ä¿¡æ¯ |
| `/api/health`    | GET  | å¥åº·æ£€æŸ¥          |

### DKI èŠå¤©è¯·æ±‚

ä¸Šå±‚åº”ç”¨åªéœ€ä¼ é€’ `user_id` å’ŒåŸå§‹è¾“å…¥ï¼š

```json
{
    "query": "æ¨èä¸€å®¶é¤å…",
    "user_id": "user_001",
    "session_id": "session_001",
    "temperature": 0.7,
    "max_tokens": 512
}
```

### DKI èŠå¤©å“åº”

```json
{
    "id": "dki-abc12345",
    "text": "æ ¹æ®æ‚¨åå¥½ç´ é£Ÿçš„ç‰¹ç‚¹...",
    "input_tokens": 128,
    "output_tokens": 256,
    "dki_metadata": {
        "injection_enabled": true,
        "alpha": 0.4,
        "preference_tokens": 85,
        "history_tokens": 320,
        "cache_hit": true,
        "cache_tier": "memory",
        "latency_ms": 156.3
    },
    "choices": [
        {
            "index": 0,
            "message": {
                "role": "assistant",
                "content": "æ ¹æ®æ‚¨åå¥½ç´ é£Ÿçš„ç‰¹ç‚¹..."
            },
            "finish_reason": "stop"
        }
    ],
    "created": 1707523200
}
```

## ğŸ”¬ ç ”ç©¶èƒŒæ™¯

### DKI çš„å®šä½ï¼šç”¨æˆ·çº§è®°å¿†ç³»ç»Ÿ

ä¸ RAG é’ˆå¯¹**å¤–éƒ¨çŸ¥è¯†**ï¼ˆæ–‡æ¡£ã€æ•°æ®åº“ã€ç½‘é¡µå†…å®¹ï¼‰ä¸åŒï¼ŒDKI ä¸“ä¸º**ç”¨æˆ·çº§è®°å¿†**è®¾è®¡ï¼š

| ç»´åº¦         | RAG            | DKI                                         |
| ------------ | -------------- | ------------------------------------------- |
| **ç›®æ ‡æ•°æ®** | å¤–éƒ¨çŸ¥è¯†åº“     | ç”¨æˆ·åå¥½ã€ä¼šè¯å†å²                          |
| **æ•°æ®è§„æ¨¡** | å¤§ï¼ˆæ•°åƒæ–‡æ¡£ï¼‰ | å°åˆ°ä¸­ï¼ˆåå¥½ 50-200ï¼Œå†å² 100-4000 tokensï¼‰ |
| **æ›´æ–°é¢‘ç‡** | æ‰¹é‡æ›´æ–°       | æ¯ä¼šè¯å®æ—¶æ›´æ–°                              |
| **éšç§**     | å…±äº«çŸ¥è¯†       | ç”¨æˆ·è‡ªæœ‰æ•°æ®                                |
| **ç¼“å­˜**     | æ–‡æ¡£çº§         | ç”¨æˆ·çº§ï¼ˆé«˜å¤ç”¨ï¼‰                            |

> **æ³¨æ„**ï¼šDKI çš„ token æ•°é‡å–å†³äºä¼šè¯å¤æ‚åº¦å’Œç›¸å…³æ€§ã€‚åå¥½æ³¨å…¥å»ºè®®ä¿æŒçŸ­å°ï¼ˆ50-200 tokensï¼‰ï¼Œè€Œå†å²æ³¨å…¥å¯æ ¹æ®éœ€è¦æ‰©å±•è‡³ 4000+ tokensã€‚é•¿å†å²å»ºè®®å¯ç”¨ç›¸å…³æ€§è¿‡æ»¤ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚

è¿™ç§èšç„¦çš„èŒƒå›´æ˜¯**åˆ»æ„è®¾è®¡**çš„ï¼Œå®ƒä½¿ DKI çš„æ ¸å¿ƒä¼˜åŠ¿å¾—ä»¥å®ç°ã€‚

### Token é¢„ç®—åˆ†æ

DKI è§£å†³äº† RAG çš„ä¸€ä¸ªæ ¹æœ¬æ€§é™åˆ¶ï¼šæ£€ç´¢åˆ°çš„å†…å®¹ä¼šæ¶ˆè€—ä¸Šä¸‹æ–‡çª—å£å®¹é‡ã€‚

**RAG èŒƒå¼ï¼š**

```
[æ£€ç´¢å†…å®¹ï¼ˆå·²æ¶ˆè€—ï¼‰] [ç”¨æˆ·è¾“å…¥ï¼ˆå‰©ä½™ç©ºé—´ï¼‰]
Tokené¢„ç®—: B_t^used = n_m + n_u
æ³¨æ„åŠ›é¢„ç®—: B_a = (n_m + n_u)Â²
```

**DKI èŒƒå¼ï¼š**

```
[ç”¨æˆ·è¾“å…¥ï¼ˆå®Œæ•´é¢„ç®—å¯ç”¨ï¼‰]
     â†‘ è®°å¿†é€šè¿‡K/Væ³¨å…¥ï¼ˆä¸å ç”¨tokené¢„ç®—ï¼‰
Tokené¢„ç®—: B_t^used = n_uï¼ˆè®°å¿†å…è´¹ï¼ï¼‰
æ³¨æ„åŠ›é¢„ç®—: B_a = n_u Ã— (n_m + n_u)
```

### DKI vs äº¤å‰æ³¨æ„åŠ›

DKI **ä¸ç­‰åŒäº**äº¤å‰æ³¨æ„åŠ›ï¼š

| ç‰¹æ€§   | DKI              | äº¤å‰æ³¨æ„åŠ›                             |
| ------ | ---------------- | -------------------------------------- |
| å‚æ•°   | é‡ç”¨ W_k, W_v    | ç‹¬ç«‹çš„ W_q^cross, W_k^cross, W_v^cross |
| è®­ç»ƒ   | æ— éœ€è®­ç»ƒ         | éœ€è¦è®­ç»ƒ                               |
| æ¶æ„   | æ— éœ€ä¿®æ”¹         | ä¸“ç”¨å±‚                                 |
| å…¼å®¹æ€§ | ä»»ä½•ä»…è§£ç å™¨ LLM | ä»…ç¼–ç å™¨-è§£ç å™¨                        |
| æ§åˆ¶   | è¿ç»­ Î±           | å­¦ä¹ æƒé‡                               |

### æ··åˆæ³¨å…¥ç­–ç•¥çš„åŸç†

ä¸ºä»€ä¹ˆå¯¹åå¥½å’Œå†å²ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ï¼Ÿ

| è®°å¿†ç±»å‹ | ç‰¹ç‚¹                                | ç­–ç•¥                 | åŸå›                           |
| -------- | ----------------------------------- | -------------------- | ----------------------------- |
| **åå¥½** | çŸ­ï¼ˆ50-200 tokensï¼‰ï¼Œç¨³å®šï¼ŒæŠ½è±¡     | K/V æ³¨å…¥ï¼ˆè´Ÿä½ç½®ï¼‰   | OOD é£é™©ä½ï¼Œå¯ç¼“å­˜ï¼Œéšå¼å½±å“  |
| **å†å²** | å¯å˜ï¼ˆ100-4000 tokensï¼‰ï¼ŒåŠ¨æ€ï¼Œå…·ä½“ | åç¼€æç¤ºè¯ï¼ˆæ­£ä½ç½®ï¼‰ | é›¶ OOD é£é™©ï¼Œå¯å¼•ç”¨ï¼Œæ˜¾å¼å‚è€ƒ |

è¿™ç§åˆ†å±‚æ–¹æ³•ï¼š

-   æœ€å°åŒ– OOD é£é™©ï¼ˆåå¥½å¾ˆçŸ­ï¼‰
-   æ”¯æŒå†å²å¼•ç”¨ï¼ˆåœ¨æç¤ºè¯ä¸­å¯è§ï¼‰
-   å‡å°‘å¹»è§‰ï¼ˆå»ºç«‹ä¿¡ä»»çš„æç¤ºè¯ï¼‰

### Token æ•°é‡ä¸æ€§èƒ½å½±å“

DKI æ”¯æŒçš„ token èŒƒå›´å–å†³äºä¼šè¯å¤æ‚åº¦å’Œç›¸å…³æ€§ï¼š

| Token èŒƒå›´ | é€‚ç”¨åœºæ™¯             | å»¶è¿Ÿå½±å“ | æ˜¾å­˜å ç”¨ï¼ˆ7B æ¨¡å‹ï¼‰ |
| ---------- | -------------------- | -------- | ------------------- |
| 100-500    | ç®€å•åå¥½ + çŸ­å†å²    | < 10%    | ~250MB              |
| 500-2000   | ä¸­ç­‰å¤æ‚åº¦ä¼šè¯       | 10-30%   | ~1GB                |
| 2000-4000  | å¤æ‚å¤šè½®ä¼šè¯         | 30-50%   | ~2GB                |
| 4000+      | é•¿æœŸä¼šè¯ï¼ˆå»ºè®®è¿‡æ»¤ï¼‰ | > 50%    | > 2GB               |

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**ï¼š

-   å¯¹äºé•¿å†å²ï¼Œå¯ç”¨ `search_relevant_history` è¿›è¡Œç›¸å…³æ€§è¿‡æ»¤
-   åå¥½ä¿æŒçŸ­å°ï¼ˆ50-200 tokensï¼‰ï¼Œåˆ©ç”¨ K/V ç¼“å­˜
-   å†å²ä½¿ç”¨åç¼€æç¤ºè¯ï¼Œå¯æ ¹æ®éœ€è¦åŠ¨æ€è°ƒæ•´é•¿åº¦

**ä¸ RAG çš„æ˜¾å­˜å¯¹æ¯”**ï¼š

-   ç›¸åŒ token æ•°é‡ä¸‹ï¼ŒDKI å’Œ RAG æ˜¾å­˜å ç”¨**åŸºæœ¬ç›¸åŒ**
-   DKI å¯èƒ½å› ç¼“å­˜å¤šè½®å†å²è€Œå ç”¨æ›´å¤šæ˜¾å­˜
-   ä½† DKI çš„ K/V ç¼“å­˜å¯å¤ç”¨ï¼Œåç»­è¯·æ±‚æ— éœ€é‡è®¡ç®—

### è®¾è®¡ä¸å˜é‡

1. **å­˜å‚¨æ¨¡å‹æ— å…³**ï¼šä»…å­˜å‚¨åŸå§‹æ–‡æœ¬ + è·¯ç”±å‘é‡
2. **æ³¨å…¥æ¨¡å‹ä¸€è‡´**ï¼šä½¿ç”¨ç›®æ ‡æ¨¡å‹å‚æ•°è®¡ç®— K/V
3. **ä¼šè¯ç¼“å­˜å¯ä¸¢å¼ƒ**ï¼šæ¨ç†æ—¶å¢å¼ºï¼ŒéæŒä¹…åŒ–è®°å¿†
4. **ä¼˜é›…é™çº§**ï¼šÎ± â†’ 0 å›é€€åˆ°æ™®é€š LLM
5. **å®¡è®¡æ—¥å¿—**ï¼šæ‰€æœ‰æ³¨å…¥å†³ç­–å‡è®°å½•ä»¥ç¬¦åˆåˆè§„è¦æ±‚

### å†…å­˜å±‚æ¬¡ï¼ˆåˆ†å±‚ KV ç¼“å­˜ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1: GPU HBM (çƒ­æ•°æ®)   - æœªå‹ç¼© FP16              â”‚
â”‚  L2: CPU RAM (æ¸©æ•°æ®)   - å‹ç¼© (2-4Ã—)              â”‚
â”‚  L3: NVMe SSD (å†·æ•°æ®)  - é‡åŒ– INT8 (8Ã—)           â”‚
â”‚  L4: ä»…æ–‡æœ¬            - æŒ‰éœ€é‡è®¡ç®—                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å†…å­˜å ç”¨ä¸**æ´»è·ƒè®°å¿†**æ•°é‡æˆæ¯”ä¾‹ï¼Œè€Œéæ€»è¯­æ–™åº“å¤§å°ã€‚

## ğŸ“„ è®¸å¯è¯

MIT è®¸å¯è¯ - è¯¦è§ LICENSE æ–‡ä»¶

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ï¼è¯·å…ˆé˜…è¯»æˆ‘ä»¬çš„è´¡çŒ®æŒ‡å—ã€‚

---

## ğŸ“š è¯¦ç»†æ–‡æ¡£

### æ ¸å¿ƒæ¦‚å¿µ

#### 1. æ³¨æ„åŠ›é¢„ç®—é‡åˆ†é…å‡è®¾

**å‡è®¾é™ˆè¿°**ï¼šåœ¨æ¨ç†å¯†é›†å‹ä»»åŠ¡ä¸­ï¼Œé‡Šæ”¾ token é¢„ç®—çš„è¾¹é™…æ”¶ç›Šè¶…è¿‡å¢åŠ æ³¨æ„åŠ›è®¡ç®—çš„è¾¹é™…æˆæœ¬ã€‚

**æ•°å­¦è¡¨è¿°**ï¼š

```
âˆ‚TaskSuccess/âˆ‚B_t^free > âˆ‚Latency/âˆ‚B_a
```

**ç›´è§‰**ï¼š

-   Token é¢„ç®—æ˜¯**ç¡¬çº¦æŸ**ï¼ˆæˆªæ–­å¯¼è‡´ä¿¡æ¯ä¸¢å¤±ï¼‰
-   æ³¨æ„åŠ›é¢„ç®—æ˜¯**è½¯çº¦æŸ**ï¼ˆå¢åŠ è®¡ç®—ï¼Œä½†æ— ä¿¡æ¯ä¸¢å¤±ï¼‰
-   å¯¹äºéœ€è¦æ·±åº¦æ¨ç†é“¾çš„ä»»åŠ¡ï¼ˆå¤šæ­¥éª¤æ•°å­¦ã€å¤æ‚è§„åˆ’ï¼‰ï¼Œä¿ç•™ç”¨äºæ¨ç†æ­¥éª¤çš„ token é¢„ç®—æä¾›çš„æ•ˆç”¨å¤§äºæ³¨æ„åŠ›å»¶è¿Ÿæˆæœ¬

#### 2. è®°å¿†å½±å“ç¼©æ”¾ï¼ˆMISï¼‰

è¿ç»­å¼ºåº¦æ§åˆ¶ Î± âˆˆ [0, 1]ï¼š

| Î± å€¼        | è¡Œä¸º                   | ç”¨ä¾‹           |
| ----------- | ---------------------- | -------------- |
| 0.0         | æ— è®°å¿†å½±å“ï¼ˆæ™®é€š LLMï¼‰ | å®‰å…¨é™çº§       |
| 0.2-0.4     | æ¸©å’Œæ³¨å…¥               | æ¢ç´¢æ€§å¯¹è¯     |
| **0.4-0.7** | **æœ€ä¼˜èŒƒå›´**           | **å¤§å¤šæ•°åœºæ™¯** |
| 0.8-1.0     | å¼ºæ³¨å…¥                 | é«˜ç½®ä¿¡åº¦è®°å¿†   |

**å®ç°**ï¼šé€šè¿‡é¢„ softmax çš„ logit åç½®åº”ç”¨ç¼©æ”¾ï¼š

```python
logit_bias = torch.log(torch.tensor(alpha + 1e-9))
logits_mem_scaled = logits_mem + logit_bias
```

#### 3. æŸ¥è¯¢æ¡ä»¶æŠ•å½±ï¼ˆQCPï¼‰

ä½¿ç”¨ FiLM é£æ ¼çš„è°ƒåˆ¶è¿›è¡ŒæŸ¥è¯¢ä¾èµ–çš„è®°å¿†æŠ•å½±ï¼š

```python
# ç”Ÿæˆè°ƒåˆ¶å‚æ•°
gamma = gamma_net(query_context)  # ç¼©æ”¾
beta = beta_net(query_context)    # åç§»

# ä½ç§©æŠ•å½±ä¸FiLMè°ƒåˆ¶
X_mem_low = X_mem @ W_mem
X_mem_modulated = X_mem_low * gamma + beta
X_mem_proj = proj_out(X_mem_modulated)

# æ®‹å·®è¿æ¥
return layer_norm(X_mem + X_mem_proj)
```

**å…³é”®åŸåˆ™**ï¼šæŠ•å½±æ˜¯**è®°å¿†ä¸­å¿ƒçš„**ï¼Œè€ŒéæŸ¥è¯¢ä¸­å¿ƒçš„â€”â€”æŸ¥è¯¢ä»…è°ƒåˆ¶ï¼Œä¸é‡æ–°ç¼–ç è®°å¿†è¯­ä¹‰ã€‚

#### 4. åŒå› å­é—¨æ§

**è®¾è®¡å†³ç­–**ï¼šæ³¨å…¥å†³ç­–ç”±**ç›¸å…³æ€§é©±åŠ¨**ï¼›ä¸ç¡®å®šæ€§ä»…**è°ƒåˆ¶ Î± çš„ä¸Šé™**ã€‚

```python
# å› å­1: è®°å¿†ç›¸å…³æ€§ï¼ˆä¸»è¦ï¼‰
inject = similarity_top1 > threshold_relevance

# å› å­2: ç†µè°ƒåˆ¶Î±ä¸Šé™ï¼ˆéå†³ç­–ï¼‰
alpha_max = entropy_floor + (entropy_ceiling - entropy_floor) * entropy

# è¿ç»­å¼ºåº¦
alpha = min(alpha_base, alpha_max)
```

**é‡è¦è¯´æ˜**ï¼šæˆ‘ä»¬ä½¿ç”¨æ³¨æ„åŠ›ç†µä½œä¸ºæ¨¡å‹ä¸ç¡®å®šæ€§çš„**å¯å‘å¼ä»£ç†**ï¼Œè€Œéä¸¥æ ¼çš„ä¸ç¡®å®šæ€§ä¼°è®¡å™¨ã€‚

### ä¸ RAG çš„å¯¹æ¯”

| ç»´åº¦       | RAG                            | DKI                  |
| ---------- | ------------------------------ | -------------------- |
| æ³¨å…¥å±‚çº§   | Token åŸŸï¼ˆæç¤ºè¯æ‹¼æ¥ï¼‰         | æ³¨æ„åŠ›åŸŸï¼ˆK/V æ³¨å…¥ï¼‰ |
| æ³¨å…¥æ§åˆ¶   | æ— ï¼ˆç¡¬æ‹¼æ¥ï¼‰                   | è¿ç»­ï¼ˆÎ± âˆˆ [0, 1]ï¼‰   |
| æç¤ºè¯æ¶ˆè€— | æ˜¯                             | å¦                   |
| ä¸Šä¸‹æ–‡çª—å£ | è¢«æ£€ç´¢å†…å®¹æ¶ˆè€—                 | å®Œå…¨å¯ç”¨äºç”¨æˆ·       |
| æç¤ºå·¥ç¨‹   | å¿…éœ€                           | ç®€åŒ–                 |
| å¯è§£é‡Šæ€§   | é«˜ï¼ˆæç¤ºè¯å¯è§ï¼‰               | ä¸­ï¼ˆéœ€æ³¨æ„åŠ›å¯è§†åŒ–ï¼‰ |
| ç”Ÿæ€æˆç†Ÿåº¦ | é«˜ï¼ˆLangChainã€LlamaIndex ç­‰ï¼‰ | ä½ï¼ˆæ–°å…´ï¼‰           |
| è°ƒè¯•       | ç›´æ¥                           | éœ€ä¸“ç”¨å·¥å…·           |

### é€‚ç”¨åœºæ™¯

#### âœ… æ¨èä½¿ç”¨ DKI çš„åœºæ™¯

1. **ä¸ªæ€§åŒ–åŠ©æ‰‹**

    - ç”¨æˆ·åå¥½éœ€è¦è·¨ä¼šè¯æŒä¹…åŒ–
    - éšå¼ä¸ªæ€§åŒ–ï¼ˆæ— éœ€åœ¨æç¤ºè¯ä¸­æ˜¾å¼æåŠï¼‰
    - å¤šè½®å¯¹è¯éœ€è¦ä¸Šä¸‹æ–‡è¿ç»­æ€§

2. **å®¢æœç³»ç»Ÿ**

    - ç”¨æˆ·ç”»åƒ + å¯¹è¯å†å²
    - è·¨ä¼šè¯ä¸€è‡´ä½“éªŒ
    - éšç§æ•æ„Ÿçš„ç”¨æˆ·æ•°æ®

3. **æ•™è‚²åº”ç”¨**

    - å­¦ä¹ åå¥½ + è¿›åº¦å†å²
    - åŸºäºç”¨æˆ·æ°´å¹³çš„è‡ªé€‚åº”å“åº”
    - é•¿æœŸç”¨æˆ·å»ºæ¨¡

4. **å¥åº·/å…»ç”ŸåŠ©æ‰‹**
    - å¥åº·æ¡£æ¡ˆ + å’¨è¯¢å†å²
    - æ•æ„Ÿä¸ªäººæ•°æ®
    - ä¸€è‡´çš„åŒ»ç–—ä¸Šä¸‹æ–‡

#### âš ï¸ å»ºè®®ä½¿ç”¨ RAG çš„åœºæ™¯

1. **å¤–éƒ¨çŸ¥è¯†æ£€ç´¢**

    - æ–‡æ¡£æœç´¢å’Œé—®ç­”
    - å…¬å…±çŸ¥è¯†åº“
    - é¢‘ç¹æ›´æ–°çš„å†…å®¹

2. **é¦–è½®å»¶è¿Ÿæåº¦æ•æ„Ÿ**

    - é¦–æ¬¡äº¤äº’å¿…é¡»æœ€å¿«
    - æ— æ³•æ¥å—é—¨æ§å¼€é”€
    - å†·å¯åŠ¨æ€§èƒ½å…³é”®

3. **é«˜å®¡è®¡è¦æ±‚**

    - éœ€è¦æ˜¾ç¤ºå®Œæ•´æ£€ç´¢å†…å®¹
    - ç›‘ç®¡æœºæ„è¦æ±‚å¯è§æç¤ºè¯
    - æ³¨æ„åŠ›å¯è§†åŒ–ä¸è¶³

4. **å¿«é€ŸåŸå‹å¼€å‘**
    - ä½¿ç”¨æˆç†Ÿ RAG ç”Ÿæ€ç³»ç»Ÿï¼ˆLangChainã€LlamaIndexï¼‰
    - éœ€è¦å¿«é€Ÿè¿­ä»£
    - æ— éœ€æ·±åº¦å®šåˆ¶

### æ€§èƒ½åŸºå‡†

åŸºäº DeepSeek-V3 7B çš„æ¨¡æ‹Ÿå®éªŒï¼ˆn=500ï¼‰ï¼š

| æŒ‡æ ‡         | RAG    | DKI        | å˜åŒ–       |
| ------------ | ------ | ---------- | ---------- |
| è®°å¿†å¬å›ç‡   | 87.3%  | 86.2%      | -1.1%      |
| é¦–è½®å»¶è¿Ÿ     | 78.8ms | 92.4ms     | +17.3%     |
| **åç»­å»¶è¿Ÿ** | 76.1ms | **42.8ms** | **-43.7%** |
| ç¼“å­˜å‘½ä¸­ç‡   | N/A    | 69.7%      | -          |
| å¹»è§‰ç‡       | 10.2%  | 10.4%      | +0.2%      |

**å…³é”®å‘ç°**ï¼š

-   DKI åœ¨é¦–è½®æœ‰ 17.3%çš„å¼€é”€ï¼Œä½†åç»­è½®æ¬¡é™ä½ 43.7%
-   3 è½®åæ€»å»¶è¿Ÿï¼šDKI < RAGï¼ˆ178.2ms vs 228.9msï¼‰
-   è®°å¿†å¬å›ä»…é™ä½ 1.1%ï¼Œå¹»è§‰ç‡ç›¸å½“

### æ•…éšœæ¨¡å¼ä¸ç¼“è§£

| æ•…éšœæ¨¡å¼   | ç—‡çŠ¶                     | æ£€æµ‹                       | ç¼“è§£                      |
| ---------- | ------------------------ | -------------------------- | ------------------------- |
| è®°å¿†æ··æ·†   | å¤šä¸ªç›¸ä¼¼è®°å¿†å¯¼è‡´æ··åˆè¾“å‡º | è®¡ç®—è®°å¿†é—´ç›¸ä¼¼åº¦           | ç›¸ä¼¼åº¦>0.9 æ—¶ä»…ä¿ç•™ top-1 |
| æ—¶é—´ä¸ä¸€è‡´ | æ—§è®°å¿†ä¸å½“å‰ä¸Šä¸‹æ–‡å†²çª   | æ£€æŸ¥è®°å¿†æ—¶é—´æˆ³ vs æŸ¥è¯¢æ—¶æ€ | ä¸º Î± æ·»åŠ æ—¶é—´è¡°å‡å› å­     |
| æŠ•å½±è¿‡æ‹Ÿåˆ | è®­ç»ƒå¥½ä½†æµ‹è¯•å·®           | ç›‘æ§éªŒè¯ vs è®­ç»ƒæŸå¤±       | å¢åŠ  dropoutï¼Œæ•°æ®å¢å¼º    |
| ç¼“å­˜æŠ–åŠ¨   | å‘½ä¸­ç‡<30%ï¼Œå»¶è¿Ÿå¢åŠ      | ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡             | å¢åŠ ç¼“å­˜å¤§å°æˆ–ä½¿ç”¨ LFU    |
| åè§æ”¾å¤§   | è®°å¿†æ³¨å…¥æ”¾å¤§æ¨¡å‹åè§     | ç›‘æ§è¾“å‡ºå¤šæ ·æ€§æŒ‡æ ‡         | å®ç°å¤šæ ·æ€§æ„ŸçŸ¥è·¯ç”±        |

### é«˜çº§ç‰¹æ€§

#### åˆ†å±‚ KV ç¼“å­˜

```python
from dki.core.components.tiered_kv_cache import TieredKVCache

cache = TieredKVCache(
    l1_size_gb=8,      # GPU
    l2_size_gb=32,     # CPU RAM
    l3_size_gb=128,    # SSD
    compression_l2=4,   # L2å‹ç¼©ç‡
    compression_l3=8    # L3å‹ç¼©ç‡
)

# è‡ªåŠ¨åˆ†å±‚ç®¡ç†
kv_pair = cache.get_or_compute(memory_id, compute_fn)
```

#### æ³¨æ„åŠ›é¢„ç®—è¿½è¸ª

```python
from dki.core.components.attention_budget import AttentionBudgetTracker

tracker = AttentionBudgetTracker()
with tracker.track_request(session_id):
    response = dki.chat(query, session_id)

# è·å–é¢„ç®—ä½¿ç”¨æƒ…å†µ
budget = tracker.get_budget_usage(session_id)
print(f"Tokené¢„ç®—ä½¿ç”¨: {budget.token_used}/{budget.token_total}")
print(f"æ³¨æ„åŠ›FLOPs: {budget.attention_flops}")
```

### ğŸ“„ ç›¸å…³è®ºæ–‡

æœ¬é¡¹ç›®åŸºäºè®ºæ–‡ã€ŠDynamic KV Injection: An Attention-Level User Memory System for Large Language Modelsã€‹å®ç°ã€‚

### å¸¸è§é—®é¢˜

**Q: DKI éœ€è¦é‡æ–°è®­ç»ƒæ¨¡å‹å—ï¼Ÿ**  
A: ä¸éœ€è¦ã€‚DKI æ˜¯æ¨ç†æ—¶å¢å¼ºï¼Œä½¿ç”¨å†»ç»“çš„æ¨¡å‹å‚æ•°ï¼Œé€šè¿‡ Attention Hook æ³¨å…¥ K/Vã€‚

**Q: DKI å’Œ RAG æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**  
A:

-   **RAG**ï¼šåœ¨ token å±‚çº§æ‹¼æ¥æ£€ç´¢å†…å®¹ï¼Œæ¶ˆè€—ä¸Šä¸‹æ–‡çª—å£
-   **DKI**ï¼šåœ¨æ³¨æ„åŠ›å±‚çº§æ³¨å…¥ K/Vï¼Œä¸æ¶ˆè€— token é¢„ç®—
-   å®ƒä»¬æ˜¯äº’è¡¥çš„ï¼šRAG å¤„ç†å¤–éƒ¨çŸ¥è¯†ï¼ŒDKI å¤„ç†ç”¨æˆ·çº§è®°å¿†

**Q: ä¸Šå±‚åº”ç”¨éœ€è¦åšä»€ä¹ˆä¿®æ”¹ï¼Ÿ**  
A:

1. æä¾›é€‚é…å™¨é…ç½®æ–‡ä»¶ï¼ˆæŒ‡å®šæ•°æ®åº“è¿æ¥å’Œå­—æ®µæ˜ å°„ï¼‰
2. åˆ é™¤ RAG/Prompt å·¥ç¨‹ä»£ç 
3. è°ƒç”¨ DKI API æ—¶ä¼ é€’ `user_id` å’ŒåŸå§‹è¾“å…¥

**Q: å¦‚æœä¸Šå±‚åº”ç”¨çš„æ•°æ®åº“æ²¡æœ‰å‘é‡ç´¢å¼•æ€ä¹ˆåŠï¼Ÿ**  
A: DKI æ”¯æŒåŠ¨æ€å‘é‡å¤„ç†ï¼Œé…ç½® `vector_search.type: dynamic` å³å¯ã€‚æ”¯æŒä¸‰ç§ç­–ç•¥ï¼š

-   `lazy`ï¼šæŒ‰éœ€è®¡ç®— embedding
-   `batch`ï¼šæ‰¹é‡é¢„è®¡ç®—
-   `hybrid`ï¼šBM25 åˆç­› + embedding é‡æ’åºï¼ˆæ¨èï¼‰

**Q: åå¥½æ³¨å…¥å’Œå†å²æ³¨å…¥æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**  
A:

-   **åå¥½**ï¼šK/V æ³¨å…¥åœ¨è´Ÿä½ç½®ï¼Œé€šè¿‡ Attention Hook å®ç°ï¼Œéšå¼å½±å“ï¼Œå¯ç¼“å­˜
-   **å†å²**ï¼šåç¼€æç¤ºè¯åœ¨æ­£ä½ç½®ï¼Œæ ‡å‡† token æ‹¼æ¥ï¼Œæ˜¾å¼å‚è€ƒï¼ŒåŠ¨æ€å˜åŒ–

**Q: å¦‚ä½•å°† DKI é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿï¼Ÿ**  
A:

```python
from dki.core.dki_plugin import DKIPlugin

# ä»é…ç½®æ–‡ä»¶åˆ›å»º (æ¨è)
dki = await DKIPlugin.from_config(
    model_adapter=your_model_adapter,
    adapter_config_path="config/adapter_config.yaml",
)

# è°ƒç”¨æ—¶åªéœ€ä¼ é€’ user_id å’ŒåŸå§‹è¾“å…¥
response = await dki.chat(
    query="ç”¨æˆ·çš„åŸå§‹è¾“å…¥",
    user_id="user_123",
    session_id="session_456",
)
```

**Q: DKI éœ€è¦è€ƒè™‘åˆ†å¸ƒå¼éƒ¨ç½²å—ï¼Ÿ**  
A: ä¸éœ€è¦ã€‚DKI ä½œä¸º LLM æ’ä»¶ï¼Œåªè´Ÿè´£è¯»å–ç”¨æˆ·é…ç½®å’Œæ¶ˆæ¯æ•°æ®å®Œæˆæ³¨å…¥ã€‚åˆ†å¸ƒå¼éƒ¨ç½²æ˜¯ LLM å¼•æ“å’Œä¸Šå±‚åº”ç”¨çš„è´£ä»»ã€‚DKI æœ¬èº«æ˜¯æ— çŠ¶æ€çš„ï¼ˆé™¤äº†åå¥½ K/V ç¼“å­˜ï¼‰ï¼Œå¯ä»¥éš LLM å®ä¾‹æ°´å¹³æ‰©å±•ã€‚

**Q: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å»ºè®®ï¼Ÿ**  
A:

1. å¯ç”¨æ··åˆæ³¨å…¥
2. åå¥½ Î± è®¾ç½®ä¸º 0.4ï¼ˆä¿å®ˆï¼‰
3. é…ç½®é€‚é…å™¨è¿æ¥åˆ°ä¸Šå±‚åº”ç”¨çš„æ•°æ®åº“
4. ç›‘æ§æ³¨å…¥ç‡å’Œå»¶è¿Ÿ
5. æ ¹æ®æŒ‡æ ‡è°ƒæ•´ alpha å’Œç¼“å­˜ç­–ç•¥

### æœ€æ–°ä¼˜åŒ– (v2.5)

#### Memory Trigger (è®°å¿†è§¦å‘å™¨)

æ£€æµ‹ç”¨æˆ·è¾“å…¥ä¸­çš„è®°å¿†ç›¸å…³ä¿¡å·ï¼Œå†³å®š"è®°ä½ä»€ä¹ˆ"ï¼š

```python
# æ”¯æŒ 5 ç§è§¦å‘ç±»å‹
- META_COGNITIVE: "æˆ‘ä»¬åˆšåˆšè®¨è®ºçš„"ã€"ä¹‹å‰ä½ è¯´è¿‡"
- STATE_CHANGE: "æˆ‘æ”¹å˜æƒ³æ³•äº†"ã€"è¡¥å……ä¸€ç‚¹"
- LONG_TERM_VALUE: "è¯·è®°ä½æˆ‘å–œæ¬¢..."ã€"æˆ‘æ˜¯ç´ é£Ÿä¸»ä¹‰è€…"
- RECALL_REQUEST: "æœ€è¿‘æˆ‘ä»¬èŠäº†ä»€ä¹ˆ"
- OPINION_QUERY: "ä½ æœ‰æ–°çœ‹æ³•å—"

# è§„åˆ™å¯é…ç½®ï¼Œåç»­å¯ç”¨åˆ†ç±»å™¨å¢å¼º
trigger = MemoryTrigger(language="auto")
result = trigger.detect("æˆ‘ä»¬åˆšæ‰èŠäº†ä»€ä¹ˆï¼Ÿ")
```

#### Reference Resolver (æŒ‡ä»£è§£æå™¨)

è§£æç”¨æˆ·è¾“å…¥ä¸­çš„æŒ‡ä»£è¡¨è¾¾ï¼Œç¡®å®šå†å²å¬å›èŒƒå›´ï¼š

```python
# å¬å›è½®æ•°å¯å¤–ç½®é…ç½®
resolver = ReferenceResolver(config=ReferenceResolverConfig(
    last_few_turns=5,    # "åˆšåˆš" å¬å› 5 è½®
    recent_turns=20,     # "æœ€è¿‘" å¬å› 20 è½®
))

# æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ›´æ–°
dki.update_reference_resolver_config(
    just_now_turns=3,
    recently_turns=15,
)
```

#### ä¸ºä»€ä¹ˆä¸éœ€è¦ Rolling Summary

ä¸ ChatGPT/Claude/Grok ç­‰ç³»ç»Ÿä¸åŒï¼ŒDKI **ä¸éœ€è¦** Rolling Summaryï¼š

| æ–¹æ¡ˆ            | åŸå›                      | DKI æ›¿ä»£æ–¹æ¡ˆ                |
| --------------- | ------------------------ | --------------------------- |
| RAG+Prompt      | ä¸Šä¸‹æ–‡çª—å£é™åˆ¶ï¼Œéœ€è¦å‹ç¼© | K/V æ³¨å…¥ä¸å ç”¨ä¸Šä¸‹æ–‡        |
| Rolling Summary | ä¿¡æ¯å‹ç¼©å¯¼è‡´ä¸¢å¤±         | Memory Trigger ç²¾å‡†å¬å›     |
| æ‘˜è¦ç”Ÿæˆ        | é¢å¤– LLM è°ƒç”¨å¼€é”€        | Reference Resolver æŒ‰éœ€æ£€ç´¢ |

### è·¯çº¿å›¾

**å·²å®Œæˆ** âœ…ï¼š

-   [x] æ ¸å¿ƒ DKI å®ç° (Attention Hook K/V æ³¨å…¥)
-   [x] vLLM/LLaMA/DeepSeek/GLM é€‚é…å™¨
-   [x] æ··åˆæ³¨å…¥ç­–ç•¥ï¼ˆåå¥½ K/V + å†å²åç¼€ï¼‰
-   [x] ~~Full Attention ç­–ç•¥~~ï¼ˆå·²å¼ƒç”¨ï¼Œå—é•¿å†å²ä¿¡æ¯å±€é™ï¼‰
-   [x] Recall v4 è®°å¿†å¬å›ç­–ç•¥ï¼ˆå¤šä¿¡å·æ£€ç´¢ + åŠ¨æ€æ‘˜è¦ + äº‹å®è¡¥å……ï¼‰
-   [x] é…ç½®é©±åŠ¨é€‚é…å™¨ï¼ˆSQLAlchemy åŠ¨æ€è¡¨æ˜ å°„ï¼‰
-   [x] JSON å†…å®¹è§£æï¼ˆæ”¯æŒåµŒå¥— key æå–ï¼‰
-   [x] åŠ¨æ€å‘é‡å¤„ç†ï¼ˆBM25 + Embedding æ··åˆæœç´¢ï¼‰
-   [x] åå¥½ K/V ç¼“å­˜ï¼ˆå†…å­˜çº§ L1ï¼‰
-   [x] Redis åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆL2ï¼Œå¯é€‰å¯ç”¨ï¼‰
-   [x] FlashAttention-3/2 é›†æˆï¼ˆè‡ªåŠ¨åç«¯æ£€æµ‹ï¼‰
-   [x] Memory Triggerï¼ˆè®°å¿†è§¦å‘æ£€æµ‹ï¼Œå¯é…ç½®è§„åˆ™ï¼‰
-   [x] Reference Resolverï¼ˆæŒ‡ä»£è§£æå™¨ï¼Œå¬å›è½®æ•°å¯é…ç½®ï¼‰
-   [x] æ³¨å…¥å¯è§†åŒ–ï¼ˆæµç¨‹å›¾ã€Token åˆ†å¸ƒã€å†å²è®°å½•ï¼‰
-   [x] ç›‘æ§ APIï¼ˆç»Ÿè®¡/æ—¥å¿—/å¥åº·æ£€æŸ¥ï¼‰
-   [x] Vue3 ç¤ºä¾‹å‰ç«¯ UIï¼ˆèŠå¤©/åå¥½/ç»Ÿè®¡/å¯è§†åŒ–ï¼‰
-   [x] å®éªŒæ¡†æ¶ï¼ˆDKI vs RAG å¯¹æ¯”ï¼‰
-   [x] å®Œæ•´å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• + è¡Œä¸ºæµ‹è¯•

**è¿›è¡Œä¸­** ğŸ”„ï¼š

-   [ ] Stance State Machine (è§‚ç‚¹çŠ¶æ€æœº)
-   [ ] åˆ†ç±»å™¨å¢å¼º Memory Trigger

**æœªæ¥å·¥ä½œ** ğŸ“‹ï¼š

-   [ ] æ³¨æ„åŠ›çƒ­åŠ›å›¾å¯è§†åŒ–ï¼ˆè°ƒè¯•ç”¨æ³¨æ„åŠ›æƒé‡åˆ†å¸ƒï¼‰
-   [ ] å¤šæ¨¡æ€æ‰©å±•ï¼ˆå›¾åƒ/éŸ³é¢‘è®°å¿†ï¼‰
-   [ ] LangChain/LlamaIndex ç”Ÿæ€é›†æˆ

---

## ğŸ”® æœªæ¥å·¥ä½œæ–¹å‘

### 1. Redis åˆ†å¸ƒå¼ç¼“å­˜é›†æˆ â­ æ¨èä¼˜å…ˆå®æ–½

**å½“å‰çŠ¶æ€**ï¼šåå¥½ K/V ç¼“å­˜ä»…åœ¨å†…å­˜ä¸­ï¼Œå•å®ä¾‹æœ‰æ•ˆã€‚

**ä¼˜åŒ–ç›®æ ‡**ï¼šé›†æˆ Redis å®ç°è·¨å®ä¾‹å…±äº«ç¼“å­˜ã€‚

**ä¸ºä»€ä¹ˆ Redis é›†æˆæ˜¯æœ€é‡è¦çš„ä¼˜åŒ–**ï¼š

DKI çš„æ ¸å¿ƒä¼˜åŠ¿ä¹‹ä¸€æ˜¯**åå¥½ K/V ç¼“å­˜å¤ç”¨**â€”â€”é¦–è½®è®¡ç®— K/V åï¼Œåç»­è¯·æ±‚ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼Œå»¶è¿Ÿé™ä½ 43.7%ã€‚ä½†å½“å‰çš„å†…å­˜ç¼“å­˜æœ‰ä¸€ä¸ªè‡´å‘½é—®é¢˜ï¼š**åªåœ¨å•å®ä¾‹æœ‰æ•ˆ**ã€‚

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒLLM æœåŠ¡é€šå¸¸æ˜¯å¤šå®ä¾‹éƒ¨ç½²ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ã€‚å¦‚æœç”¨æˆ·çš„è¯·æ±‚è¢«è·¯ç”±åˆ°ä¸åŒå®ä¾‹ï¼Œç¼“å­˜å°±ä¼šå¤±æ•ˆï¼ŒDKI çš„æ ¸å¿ƒä¼˜åŠ¿å°†å¤§æ‰“æŠ˜æ‰£ï¼š

| éƒ¨ç½²æ¨¡å¼ | ç¼“å­˜å‘½ä¸­ç‡ | DKI ä¼˜åŠ¿ |
| -------- | ---------- | -------- |
| å•å®ä¾‹   | ~70%       | å®Œæ•´å‘æŒ¥ |
| 2 å®ä¾‹   | ~35%       | å‡åŠ     |
| 4 å®ä¾‹   | ~17.5%     | å¤§å¹…å‰Šå¼± |
| N å®ä¾‹   | ~70%/N     | å‡ ä¹æ— æ•ˆ |

**Redis é›†æˆå**ï¼šæ— è®ºå¤šå°‘å®ä¾‹ï¼Œç¼“å­˜å‘½ä¸­ç‡å§‹ç»ˆä¿æŒ ~70%ï¼ŒDKI ä¼˜åŠ¿å®Œæ•´å‘æŒ¥ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å½“å‰æ¶æ„ (å•å®ä¾‹ç¼“å­˜)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  LLM Instance 1          LLM Instance 2          LLM Instance 3         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ DKI Plugin  â”‚         â”‚ DKI Plugin  â”‚         â”‚ DKI Plugin  â”‚        â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚
â”‚  â”‚ â”‚ å†…å­˜ç¼“å­˜ â”‚ â”‚         â”‚ â”‚ å†…å­˜ç¼“å­˜ â”‚ â”‚        â”‚ â”‚ å†…å­˜ç¼“å­˜ â”‚ â”‚        â”‚
â”‚  â”‚ â”‚ user_001â”‚ â”‚         â”‚ â”‚ user_002 â”‚ â”‚        â”‚ â”‚ user_003â”‚ â”‚        â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                         â”‚
â”‚  é—®é¢˜ï¼š                                                                  â”‚
â”‚  - user_001 è¯·æ±‚åˆ° Instance 2 æ—¶ï¼Œç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€é‡æ–°è®¡ç®— K/V               â”‚
â”‚  - ç¼“å­˜å‘½ä¸­ç‡éšå®ä¾‹æ•°å¢åŠ è€Œä¸‹é™                                            â”‚
â”‚  - æ— æ³•å®ç°çœŸæ­£çš„æ°´å¹³æ‰©å±•                                                 â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¼˜åŒ–æ¶æ„ (Redis åˆ†å¸ƒå¼ç¼“å­˜)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  LLM Instance 1          LLM Instance 2          LLM Instance 3         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ DKI Plugin  â”‚         â”‚ DKI Plugin  â”‚         â”‚ DKI Plugin  â”‚        â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚        â”‚
â”‚  â”‚ â”‚ L1 å†…å­˜  â”‚ â”‚        â”‚ â”‚ L1 å†…å­˜  â”‚ â”‚         â”‚ â”‚ L1 å†…å­˜ â”‚ â”‚        â”‚
â”‚  â”‚ â”‚ (çƒ­æ•°æ®) â”‚ â”‚        â”‚ â”‚ (çƒ­æ•°æ®) â”‚ â”‚         â”‚ â”‚ (çƒ­æ•°æ®) â”‚ â”‚        â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚         â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚         â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â”‚                       â”‚                       â”‚               â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                 â–¼                                       â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚      Redis Cluster       â”‚                         â”‚
â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                         â”‚
â”‚                    â”‚  â”‚ L2 åˆ†å¸ƒå¼ç¼“å­˜        â”‚ â”‚                         â”‚
â”‚                    â”‚  â”‚ user_001, user_002  â”‚ â”‚                         â”‚
â”‚                    â”‚  â”‚ user_003, ...       â”‚ â”‚                         â”‚
â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                                         â”‚
â”‚  ä¼˜åŠ¿ï¼š                                                                  â”‚
â”‚  - ä»»æ„å®ä¾‹éƒ½èƒ½å‘½ä¸­ç¼“å­˜                                                   â”‚
â”‚  - ç¼“å­˜å‘½ä¸­ç‡ä¸å—å®ä¾‹æ•°å½±å“                                               â”‚
â”‚  - æ”¯æŒçœŸæ­£çš„æ°´å¹³æ‰©å±•                                                     â”‚
â”‚  - ç¼“å­˜æŒä¹…åŒ–ï¼Œé‡å¯ä¸ä¸¢å¤±                                                 â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°æ–¹æ¡ˆ**ï¼š

```python
# é…ç½®ç¤ºä¾‹
cache:
  type: tiered  # memory | redis | tiered
  tiered:
    l1:
      type: memory
      max_size_mb: 512
      ttl: 300  # 5 åˆ†é’Ÿ
    l2:
      type: redis
      host: redis-cluster.example.com
      port: 6379
      password: ${REDIS_PASSWORD}
      db: 0
      ttl: 3600  # 1 å°æ—¶
      key_prefix: "dki:kv:"
      serialization: msgpack  # å‹ç¼©åºåˆ—åŒ–
```

**å¯è¡Œæ€§è¯„ä¼°**ï¼š

| ç»´åº¦       | è¯„ä¼°      | è¯´æ˜                                             |
| ---------- | --------- | ------------------------------------------------ |
| æŠ€æœ¯å¤æ‚åº¦ | â­â­ ä¸­ç­‰ | Redis å®¢æˆ·ç«¯æˆç†Ÿï¼Œä¸»è¦å·¥ä½œæ˜¯åºåˆ—åŒ– K/V Tensor    |
| æ€§èƒ½å½±å“   | â­â­ ä¸­ç­‰ | ç½‘ç»œå»¶è¿Ÿ ~1-5msï¼Œä½†é¿å…äº† K/V é‡è®¡ç®— (~50-200ms) |
| æ”¶ç›Š       | â­â­â­ é«˜ | å¤šå®ä¾‹éƒ¨ç½²å¿…éœ€ï¼Œç¼“å­˜å‘½ä¸­ç‡æå‡æ˜¾è‘—               |
| ä¾èµ–       | â­ ä½     | ä»…éœ€ redis-pyï¼Œå¯é€‰ä¾èµ–                          |

**å…³é”®æŠ€æœ¯ç‚¹**ï¼š

1. **K/V Tensor åºåˆ—åŒ–**ï¼šä½¿ç”¨ `msgpack` + `numpy` å‹ç¼©ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“
2. **ç¼“å­˜å¤±æ•ˆç­–ç•¥**ï¼šåå¥½å˜æ›´æ—¶ä¸»åŠ¨å¤±æ•ˆï¼ŒTTL å…œåº•
3. **çƒ­ç‚¹æ•°æ®æœ¬åœ°ç¼“å­˜**ï¼šL1 å†…å­˜ç¼“å­˜é«˜é¢‘ç”¨æˆ·ï¼Œå‡å°‘ Redis è®¿é—®

### 2. æ³¨æ„åŠ›å¯è§†åŒ–å·¥å…·

**ç›®æ ‡**ï¼šè°ƒè¯• K/V æ³¨å…¥æ•ˆæœï¼Œç†è§£æ³¨å…¥å¯¹æ³¨æ„åŠ›åˆ†å¸ƒçš„å½±å“ã€‚

**è®¾è®¡æ–¹æ¡ˆ**ï¼š

```python
# å¯è§†åŒ– API
from dki.visualization import AttentionVisualizer

visualizer = AttentionVisualizer(dki_plugin)

# ç”Ÿæˆæ³¨æ„åŠ›çƒ­åŠ›å›¾
heatmap = visualizer.generate_heatmap(
    query="æ¨èä¸€å®¶é¤å…",
    user_id="user_001",
    layer_indices=[0, 12, 24],  # å¯è§†åŒ–ç‰¹å®šå±‚
)

# å¯¹æ¯”æ³¨å…¥å‰å
comparison = visualizer.compare_injection(
    query="æ¨èä¸€å®¶é¤å…",
    user_id="user_001",
    show_diff=True,
)

# å¯¼å‡ºä¸º HTML æŠ¥å‘Š
visualizer.export_report("attention_analysis.html")
```

**å¯è¡Œæ€§è¯„ä¼°**ï¼š

| ç»´åº¦       | è¯„ä¼°      | è¯´æ˜                               |
| ---------- | --------- | ---------------------------------- |
| æŠ€æœ¯å¤æ‚åº¦ | â­â­ ä¸­ç­‰ | éœ€è¦ Hook æ³¨æ„åŠ›æƒé‡ï¼Œå¯è§†åŒ–åº“æˆç†Ÿ |
| æ€§èƒ½å½±å“   | â­â­â­ é«˜ | ä»…è°ƒè¯•æ—¶å¯ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒå…³é—­         |
| æ”¶ç›Š       | â­â­ ä¸­ç­‰ | è°ƒè¯•å’Œè®ºæ–‡å±•ç¤ºæœ‰ä»·å€¼               |
| ä¾èµ–       | â­ ä½     | matplotlib, plotly ç­‰å¯é€‰ä¾èµ–      |

### 3. å¤šæ¨¡æ€æ‰©å±•ï¼ˆå›¾åƒ/éŸ³é¢‘è®°å¿†ï¼‰

**ç›®æ ‡**ï¼šæ”¯æŒå›¾åƒå’ŒéŸ³é¢‘ä½œä¸ºç”¨æˆ·è®°å¿†çš„ä¸€éƒ¨åˆ†ã€‚

**è®¾è®¡æ–¹æ¡ˆ**ï¼š

```python
# å¤šæ¨¡æ€åå¥½
preferences = [
    {"type": "text", "content": "å–œæ¬¢ç®€çº¦é£æ ¼"},
    {"type": "image", "content": "user_avatar.jpg", "embedding": [...]},
    {"type": "audio", "content": "voice_sample.wav", "embedding": [...]},
]

# å¤šæ¨¡æ€ K/V æ³¨å…¥
# å›¾åƒ/éŸ³é¢‘å…ˆé€šè¿‡ç¼–ç å™¨è½¬æ¢ä¸º embeddingï¼Œå†è®¡ç®— K/V
```

**å¯è¡Œæ€§è¯„ä¼°**ï¼š

| ç»´åº¦       | è¯„ä¼°      | è¯´æ˜                                 |
| ---------- | --------- | ------------------------------------ |
| æŠ€æœ¯å¤æ‚åº¦ | â­â­â­ é«˜ | éœ€è¦å¤šæ¨¡æ€ç¼–ç å™¨ï¼ŒK/V è®¡ç®—æ–¹å¼éœ€è°ƒæ•´ |
| æ€§èƒ½å½±å“   | â­â­â­ é«˜ | å›¾åƒ/éŸ³é¢‘ç¼–ç å¼€é”€å¤§                  |
| æ”¶ç›Š       | â­â­ ä¸­ç­‰ | ç‰¹å®šåœºæ™¯æœ‰ä»·å€¼ï¼ˆå¦‚è™šæ‹ŸåŠ©æ‰‹ï¼‰         |
| ä¾èµ–       | â­â­â­ é«˜ | éœ€è¦ CLIPã€Whisper ç­‰æ¨¡å‹            |

**å»ºè®®**ï¼šä½œä¸ºé•¿æœŸç›®æ ‡ï¼Œä¼˜å…ˆçº§è¾ƒä½ã€‚

### 4. LangChain/LlamaIndex é›†æˆ

**ç›®æ ‡**ï¼šå°† DKI åŒ…è£…ä¸º LangChain/LlamaIndex æ¨¡å—ï¼Œæ‰©å¤§ç”Ÿæ€ã€‚

**è®¾è®¡æ–¹æ¡ˆ**ï¼š

```python
# LangChain é›†æˆ
from langchain_dki import DKIMemory

memory = DKIMemory(
    adapter_config_path="config/adapter_config.yaml",
)

chain = ConversationChain(
    llm=llm,
    memory=memory,  # DKI ä½œä¸º Memory æ¨¡å—
)

# LlamaIndex é›†æˆ
from llama_index_dki import DKIRetriever

retriever = DKIRetriever(
    adapter_config_path="config/adapter_config.yaml",
)

query_engine = index.as_query_engine(
    retriever=retriever,  # DKI ä½œä¸º Retriever
)
```

**å¯è¡Œæ€§è¯„ä¼°**ï¼š

| ç»´åº¦       | è¯„ä¼°      | è¯´æ˜                                |
| ---------- | --------- | ----------------------------------- |
| æŠ€æœ¯å¤æ‚åº¦ | â­â­ ä¸­ç­‰ | éœ€è¦é€‚é… LangChain/LlamaIndex æ¥å£  |
| æ€§èƒ½å½±å“   | â­ ä½     | ä»…å°è£…å±‚ï¼Œæ— é¢å¤–å¼€é”€                |
| æ”¶ç›Š       | â­â­â­ é«˜ | æ‰©å¤§ç”¨æˆ·ç¾¤ï¼Œé™ä½ä½¿ç”¨é—¨æ§›            |
| ä¾èµ–       | â­â­ ä¸­ç­‰ | langchain, llama-index ä½œä¸ºå¯é€‰ä¾èµ– |

**å»ºè®®**ï¼šä¼˜å…ˆçº§ä¸­ç­‰ï¼Œå¾…æ ¸å¿ƒåŠŸèƒ½ç¨³å®šåå®æ–½ã€‚

### 5. FlashAttention-3 é›†æˆ â­ å·²å®ç°

**ç›®æ ‡**ï¼šé›†æˆ FlashAttention-3/2 ä¼˜åŒ– K/V æ³¨å…¥çš„æ³¨æ„åŠ›è®¡ç®—ã€‚

**å½“å‰çŠ¶æ€**ï¼šâœ… å·²å®ç°åŸºç¡€æ¡†æ¶ï¼Œæ”¯æŒè‡ªåŠ¨åç«¯æ£€æµ‹å’Œä¼˜é›…é™çº§ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š

| åœºæ™¯          | æ ‡å‡†å®ç° | FlashAttention-3 | æå‡     |
| ------------- | -------- | ---------------- | -------- |
| åå¥½ K/V è®¡ç®— | ~50ms    | ~15ms            | **70%â†“** |
| å¸¦æ³¨å…¥æ¨ç†    | ~200ms   | ~80ms            | **60%â†“** |
| GPU å†…å­˜å ç”¨  | 24GB     | 14GB             | **42%â†“** |

**GPU æ”¯æŒçŸ©é˜µ**ï¼š

| GPU ç±»å‹  | åç«¯     | æ”¯æŒçŠ¶æ€           |
| --------- | -------- | ------------------ |
| H100/H200 | FA3      | âœ… å®Œæ•´æ”¯æŒ (æœ€ä½³) |
| A100      | FA2      | âœ… æ”¯æŒ            |
| RTX 4090  | FA2      | âœ… æ”¯æŒ            |
| V100      | Standard | âš ï¸ é™çº§åˆ°æ ‡å‡†å®ç°  |

**ä½¿ç”¨æ–¹å¼**ï¼š

```python
from dki.attention import FlashAttentionConfig

# å¯ç”¨ FlashAttention
model_adapter.enable_flash_attention(
    config=FlashAttentionConfig(
        backend="auto",  # è‡ªåŠ¨æ£€æµ‹ GPU
        kv_injection={"chunk_size": 1024},
    )
)

# æŸ¥çœ‹ç»Ÿè®¡
stats = model_adapter.get_flash_attn_stats()
```

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
# config/config.yaml
flash_attention:
    enabled: true
    backend: "auto" # auto | fa3 | fa2 | standard
    fa3:
        use_fp8: false
        enable_async: true
    kv_injection:
        enabled: true
        strategy: "prepend"
        chunked: true
        chunk_size: 1024
```

è¯¦ç»†æ–‡æ¡£è¯·å‚é˜…ï¼š[FlashAttention-3 é›†æˆæ–¹æ¡ˆ](docs/FlashAttention3_Integration.md)

### ä¼˜å…ˆçº§æ’åº

| ä¼˜å…ˆçº§ | ä¼˜åŒ–æ–¹å‘                  | åŸå›                       |
| ------ | ------------------------- | ------------------------- |
| P0     | FlashAttention-3 é›†æˆ     | âœ… å·²å®ç°ï¼Œæ€§èƒ½æå‡æ˜¾è‘—   |
| P1     | Redis åˆ†å¸ƒå¼ç¼“å­˜          | âœ… å·²å®ç°ï¼Œå¤šå®ä¾‹éƒ¨ç½²å¿…éœ€ |
| P2     | æ³¨æ„åŠ›å¯è§†åŒ–              | è°ƒè¯•å’Œè®ºæ–‡å±•ç¤ºæœ‰ä»·å€¼      |
| P3     | LangChain/LlamaIndex é›†æˆ | æ‰©å¤§ç”Ÿæ€ï¼Œä½†éæ ¸å¿ƒåŠŸèƒ½    |
| P4     | å¤šæ¨¡æ€æ‰©å±•                | æŠ€æœ¯å¤æ‚åº¦é«˜ï¼Œç‰¹å®šåœºæ™¯    |

> ğŸ“‹ è¯¦ç»†çš„åç»­ä¼˜åŒ–æ–¹æ¡ˆã€äº§å“åŒ–ä»·å€¼åˆ†æå’Œå¸‚åœºå¯è¡Œæ€§è¯„ä¼°ï¼Œè¯·å‚é˜… [DKI åç»­ä¼˜åŒ–æ–¹æ¡ˆä¸äº§å“åŒ–åˆ†æ](docs/DKI_Optimization_Roadmap.md)ã€‚

### Redis é›†æˆçš„é¢å¤–ä»·å€¼

é™¤äº†è§£å†³å¤šå®ä¾‹ç¼“å­˜é—®é¢˜ï¼ŒRedis é›†æˆè¿˜å¸¦æ¥ä»¥ä¸‹ä»·å€¼ï¼š

1. **ç¼“å­˜æŒä¹…åŒ–**

    - æœåŠ¡é‡å¯åç¼“å­˜ä¸ä¸¢å¤±
    - å‡å°‘å†·å¯åŠ¨æ—¶çš„ K/V é‡è®¡ç®—

2. **ç¼“å­˜é¢„çƒ­**

    - å¯ä»¥æå‰è®¡ç®—é«˜é¢‘ç”¨æˆ·çš„ K/V
    - æ‰¹é‡å¯¼å…¥å†å²ç”¨æˆ·åå¥½

3. **ç¼“å­˜ç›‘æ§**

    - Redis æä¾›ä¸°å¯Œçš„ç›‘æ§æŒ‡æ ‡
    - å¯ä»¥åˆ†æç¼“å­˜å‘½ä¸­ç‡ã€å†…å­˜ä½¿ç”¨ç­‰

4. **ç¼“å­˜æ·˜æ±°ç­–ç•¥**

    - LRU/LFU ç­‰æˆç†Ÿç­–ç•¥
    - è‡ªåŠ¨ç®¡ç†ç¼“å­˜å®¹é‡

5. **è·¨æœåŠ¡å…±äº«**
    - å¤šä¸ª DKI å®ä¾‹å…±äº«åŒä¸€ç¼“å­˜
    - ç”šè‡³å¯ä»¥è·¨ä¸åŒ LLM æœåŠ¡å…±äº«ï¼ˆå¦‚æœä½¿ç”¨ç›¸åŒæ¨¡å‹ï¼‰

**æˆæœ¬åˆ†æ**ï¼š

| èµ„æº       | ä¼°ç®—          | è¯´æ˜                 |
| ---------- | ------------- | -------------------- |
| Redis å†…å­˜ | ~100MB/ä¸‡ç”¨æˆ· | å‡è®¾æ¯ç”¨æˆ· K/V ~10KB |
| ç½‘ç»œå»¶è¿Ÿ   | 1-5ms         | å±€åŸŸç½‘å†…             |
| è¿ç»´æˆæœ¬   | ä½            | Redis è¿ç»´æˆç†Ÿ       |

**ROI åˆ†æ**ï¼š

```
å‡è®¾ï¼š
- 4 å®ä¾‹éƒ¨ç½²
- å½“å‰ç¼“å­˜å‘½ä¸­ç‡ ~17.5% (70%/4)
- Redis åç¼“å­˜å‘½ä¸­ç‡ ~70%

æ”¶ç›Šï¼š
- ç¼“å­˜å‘½ä¸­ç‡æå‡ 4x
- åç»­è½®æ¬¡å»¶è¿Ÿé™ä½ ~40%
- æ•´ä½“ååé‡æå‡ ~30%

æˆæœ¬ï¼š
- Redis å®ä¾‹ ~$50/æœˆ (äº‘æœåŠ¡)
- å¼€å‘å·¥ä½œé‡ ~2-3 äººå¤©
```

### ç¤ºä¾‹å‰ç«¯ UI

DKI æä¾›äº†ä¸€ä¸ªåŸºäº **Vue3** çš„ç¤ºä¾‹å‰ç«¯ UIï¼Œç”¨äºæ¼”ç¤º DKI é›†æˆï¼š

-   **Vue 3 + TypeScript**ï¼šç±»å‹å®‰å…¨çš„ç°ä»£å‰ç«¯å¼€å‘
-   **Vite**ï¼šå¿«é€Ÿçš„å¼€å‘æœåŠ¡å™¨å’Œæ„å»ºå·¥å…·
-   **Pinia**ï¼šVue3 å®˜æ–¹çŠ¶æ€ç®¡ç†
-   **Element Plus**ï¼šä¼ä¸šçº§ UI ç»„ä»¶åº“

UI åŠŸèƒ½ï¼š

-   èŠå¤©ç•Œé¢ï¼ˆæ˜¾ç¤º DKI å…ƒæ•°æ®å¾½ç« ï¼‰
-   ç”¨æˆ·åå¥½ç®¡ç†é¢æ¿
-   ä¼šè¯å†å²æµè§ˆ
-   ç³»ç»Ÿç»Ÿè®¡ä»ªè¡¨æ¿ï¼ˆéœ€å¯†ç ï¼‰

**æ³¨æ„**ï¼šChat UI æ˜¯ç¤ºä¾‹åº”ç”¨ï¼ŒDKI çš„é€‚é…å™¨ä¼šè¯»å–å…¶æ•°æ®åº“æ¥è·å–ç”¨æˆ·åå¥½å’Œå†å²æ¶ˆæ¯ã€‚

### è‡´è°¢

æœ¬é¡¹ç›®å—åˆ°ä»¥ä¸‹ç ”ç©¶çš„å¯å‘ï¼š

-   RAG ([Lewis et al., 2020](https://arxiv.org/abs/2005.11401))
-   RETRO ([Borgeaud et al., 2022](https://arxiv.org/abs/2112.04426))
-   Self-RAG ([Asai et al., 2023](https://arxiv.org/abs/2310.11511))
-   FiLM ([Perez et al., 2018](https://arxiv.org/abs/1709.07871))
-   FlashAttention ([Dao et al., 2022](https://arxiv.org/abs/2205.14135))

---

**DKI** - åœ¨æ³¨æ„åŠ›å±‚çº§é‡æ–°æ€è€ƒè®°å¿†å¢å¼º
